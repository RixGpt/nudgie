<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nudgie â€” Birthdays</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --border: rgba(15, 23, 42, 0.10);
      --soft:#f6f8fb;
    }

    body { color: var(--ink); background: #fff; }
    a { text-decoration: none; }
    a:hover { text-decoration: underline; }

    .brand { font-weight: 800; letter-spacing: 0.2px; }

    /* Page section background like home */
    .page-wrap{
      background: var(--soft);
      border-bottom: 1px solid rgba(15,23,42,0.06);
    }

    /* Birthday card style */
    .bday-card{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 1.25rem;
      padding: 1.25rem 1.25rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
    }
    .bday-topdate{
      font-size: 1.05rem;
      color: #6b7280;
      margin-bottom: .6rem;
    }
    .bday-title{
      font-weight: 800;
      letter-spacing: -0.01em;
      margin-bottom: .25rem;
    }
    .bday-meta{
      color: #6b7280;
      margin: 0;
    }

    /* Icon buttons */
    .icon-btn{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }
    .icon-btn .bi{ font-size: 1.05rem; line-height: 1; }

    @media (max-width: 576px) {
      .bday-card{ padding: 1rem; }
      .bday-topdate{ font-size: 1rem; }
    }
  </style>
</head>

<body>
  <!-- Homepage-matching nav -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container py-2">
      <a class="navbar-brand brand" href="index.html">Nudgie</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topnav" aria-controls="topnav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="topnav">
        <div class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
          <a class="nav-link" href="about.html">About</a>
          <a class="nav-link" href="contact.html">Contact</a>
          <button class="btn btn-outline-primary btn-sm ms-lg-2" id="logoutBtn" type="button">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Page header band (similar vibe to home hero area, but smaller) -->
  <section class="page-wrap">
    <div class="container py-4">
      <div class="d-flex flex-wrap justify-content-between align-items-end gap-2">
        <div>
          <h1 class="h3 fw-bold mb-1">Birthdays</h1>
          <p class="text-secondary mb-0">Add, edit, and see upcoming birthdays.</p>
        </div>
        <a class="btn btn-primary" href="login.html" id="loginCta" style="display:none;">Log in</a>
      </div>
    </div>
  </section>

  <main class="container py-4">
    <div class="row g-3">

      <!-- Add form -->
      <div class="col-12" id="addWrap" style="display:none;">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <form id="addForm" class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">First name</label>
                <input id="firstName" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">Last name</label>
                <input id="lastName" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Date of birth</label>
                <input id="dob" type="date" class="form-control" required>
              </div>
              <div class="col-md-1">
                <button class="btn btn-primary w-100" type="submit">+</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- List (Cards) -->
      <div class="col-12" id="listWrap" style="display:none;">
        <div class="d-grid gap-3" id="cards"></div>
      </div>

      <!-- Empty state -->
      <div class="col-12" id="emptyState" style="display:none;">
        <div class="card shadow-sm border-0">
          <div class="card-body text-center text-muted">
            <div class="mb-2">No birthdays yet.</div>
            <div>Add one above to get started. ðŸŽ‚</div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Homepage-matching footer -->
  <footer class="border-top bg-white">
    <div class="container py-3 d-flex justify-content-between small text-secondary">
      <div>Â© <span id="yr"></span> Nudgie</div>
      <div class="d-flex gap-3">
        <a class="text-secondary" href="about.html">About</a>
        <a class="text-secondary" href="contact.html">Contact</a>
      </div>
    </div>
  </footer>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit birthday</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm" class="row g-2">
            <input type="hidden" id="editId">
            <div class="col-md-6">
              <label class="form-label small text-muted mb-1">First name</label>
              <input id="editFirst" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted mb-1">Last name</label>
              <input id="editLast" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted mb-1">Date of birth</label>
              <input id="editDob" type="date" class="form-control" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEdit">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.getElementById('yr').textContent = new Date().getFullYear();

    // ===== CONFIG =====
    const AIRTABLE_TOKEN = 'pat7FJIZ2jVBPvyFJ.f3f48877944f4a6e2ac0d591468113c051dce38e080d11a4821c37151c5d6a9b'; // replace
    const AIRTABLE_BASE  = 'appDw2ve8ICnaUL6g'; // replace
    const BDAY_URL       = `https://api.airtable.com/v0/${AIRTABLE_BASE}/birthdays`;
    const headers = { Authorization: `Bearer ${AIRTABLE_TOKEN}`, 'Content-Type': 'application/json' };

    // ===== Session helpers =====
    function getSession(){ try { return JSON.parse(localStorage.getItem('nudgie_session')||'null'); } catch(_){ return null; } }
    function ensureLogin(){
      const s = getSession();
      const addWrap = document.getElementById('addWrap');
      const listWrap = document.getElementById('listWrap');
      const loginCta = document.getElementById('loginCta');
      if(!s){ loginCta.style.display='inline-block'; return null; }
      addWrap.style.display=''; listWrap.style.display=''; return s;
    }
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('nudgie_session');
      location.href = 'login.html';
    });

    // ===== Date helpers (handle ISO or Y-M-D, avoid TZ drift) =====
    function pad(n){ return String(n).padStart(2,'0'); }
    function toYMD(date){ return date.getFullYear()+'-'+pad(date.getMonth()+1)+'-'+pad(date.getDate()); }

    function normalizeYMD(v){
      if(!v) return '';
      if (typeof v === 'string') {
        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
        if (v.includes('T')) return v.substring(0,10);
      }
      const d = new Date(v);
      return isNaN(d) ? '' : toYMD(d);
    }

    function parseYMD(ymd){
      if(!ymd) return null;
      const [y,m,d]=ymd.split('-').map(Number);
      return new Date(y, m-1, d);
    }

    function ordinal(n){
      const s=["th","st","nd","rd"], v=n%100;
      return n + (s[(v-20)%10] || s[v] || s[0]);
    }
    function prettyDateLong(ymd){
      const d = parseYMD(ymd); if(!d) return '';
      const day = ordinal(d.getDate());
      const month = d.toLocaleDateString(undefined, { month:'long' });
      const year = d.getFullYear();
      return `${day} of ${month} ${year}`;
    }

    function daysUntil(ymd){
      const target = parseYMD(ymd);
      if(!target) return '';
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const t = new Date(target.getFullYear(), target.getMonth(), target.getDate());
      const diffMs = t - today;
      return Math.max(0, Math.round(diffMs / (1000*60*60*24)));
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // ===== Airtable helpers =====
    async function fetchMine(email){
      const filter = "LOWER({user_email})='" + email.toLowerCase() + "'";
      const url = BDAY_URL + "?filterByFormula=" + encodeURIComponent(filter) + "&pageSize=100";
      const res = await fetch(url, { headers: { Authorization: "Bearer " + AIRTABLE_TOKEN } });
      const data = await res.json();
      return data.records || [];
    }

    async function createRec(fields){
      const res = await fetch(BDAY_URL, { method:'POST', headers, body: JSON.stringify({ fields }) });
      return res.json();
    }

    async function patchRec(id, fields){
      const res = await fetch(BDAY_URL + "/" + id, { method:'PATCH', headers, body: JSON.stringify({ fields }) });
      return res.json();
    }

    async function deleteRec(id){
      await fetch(BDAY_URL + "/" + id, {
        method:'DELETE',
        headers:{ Authorization: "Bearer " + AIRTABLE_TOKEN }
      });
    }

    // ===== Render (Cards) =====
    const cards = document.getElementById('cards');

    function renderCards(rows){
      cards.innerHTML = '';

      rows.forEach(rec => {
        const f = rec.fields || {};
        const first = (f.first_name || '').trim();
        const last  = (f.last_name || '').trim();
        const name  = (first + ' ' + last).trim() || '(No name)';

        const dobY = normalizeYMD(f.date || '');
        const nbY  = normalizeYMD(f.next_birthday || '');

        const dobPretty  = dobY ? prettyDateLong(dobY) : '';
        const nextPretty = nbY ? prettyDateLong(nbY) : '';
        const d2g = nbY ? daysUntil(nbY) : '';

        const wrap = document.createElement('div');
        wrap.className = 'bday-card';

        wrap.innerHTML = `
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div class="flex-grow-1">
              <div class="bday-topdate">${escapeHtml(dobPretty)}</div>
              <div class="h3 bday-title mb-1">${escapeHtml(name)}'s Birthday</div>
              <p class="bday-meta">Next birthday: ${escapeHtml(nextPretty)}</p>
              <p class="bday-meta">Days to go: ${d2g !== '' ? d2g + ' days' : ''}</p>
            </div>

            <div class="d-flex gap-2 flex-shrink-0">
              <button class="btn btn-outline-secondary icon-btn" type="button" data-action="edit" aria-label="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger icon-btn" type="button" data-action="del" aria-label="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;

        wrap.querySelector('[data-action="edit"]').addEventListener('click', ()=> openEdit(rec));
        wrap.querySelector('[data-action="del"]').addEventListener('click', async ()=>{
          if(confirm('Delete this birthday?')){
            await deleteRec(rec.id);
            await load();
          }
        });

        cards.appendChild(wrap);
      });
    }

    // ===== Edit modal logic =====
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    function openEdit(rec){
      const f = rec.fields || {};
      document.getElementById('editId').value = rec.id;
      document.getElementById('editFirst').value = f.first_name || '';
      document.getElementById('editLast').value  = f.last_name  || '';
      document.getElementById('editDob').value   = normalizeYMD(f.date || '');
      editModal.show();
    }

    document.getElementById('saveEdit').addEventListener('click', async ()=>{
      const id    = document.getElementById('editId').value;
      const first = document.getElementById('editFirst').value.trim();
      const last  = document.getElementById('editLast').value.trim();
      const dob   = document.getElementById('editDob').value;

      await patchRec(id, { first_name:first, last_name:last, date:dob });

      editModal.hide();
      await load();
    });

    // ===== Add flow =====
    document.getElementById('addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const s = getSession(); if(!s) return;

      const first = document.getElementById('firstName').value.trim();
      const last  = document.getElementById('lastName').value.trim();
      const dob   = document.getElementById('dob').value;

      await createRec({ user_email: s.email, first_name:first, last_name:last, date:dob });

      e.target.reset();
      await load();
    });

    // ===== Load & init =====
    async function load(){
      const s = getSession();
      const empty = document.getElementById('emptyState');
      const listWrap = document.getElementById('listWrap');
      if(!s) return;

      let rows = await fetchMine(s.email);

      rows = rows.sort((a,b)=>{
        const ay = normalizeYMD(a.fields.next_birthday || '2100-01-01');
        const by = normalizeYMD(b.fields.next_birthday || '2100-01-01');
        return parseYMD(ay) - parseYMD(by);
      });

      if(rows.length === 0){
        empty.style.display = '';
        listWrap.style.display = 'none';
      } else {
        empty.style.display = 'none';
        listWrap.style.display = '';
        renderCards(rows);
      }
    }

    (async function init(){
      const s = ensureLogin();
      if(!s) return;
      await load();
    })();
  </script>
</body>
</html>
