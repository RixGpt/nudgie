<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nudgie - Place Reminders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>

  <!-- Header -->
  <div class="header-bar mb-4">
    <div class="container-narrow px-3 px-sm-4 d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <i class="fas fa-dove"></i>
        <div>
          <h1 class="title mb-0">Nudgie</h1>
          <p class="subtitle mb-0">A smart nudge when you need it</p>
        </div>
      </div>
      <a href="index.html" class="btn btn-outline-primary btn-sm">Home</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container-narrow px-3 px-sm-4">

    <div id="menu-container"></div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">Place Reminders</h2>
    </div>

    <!-- Toggle Button -->
    <button id="toggleFormBtn" class="btn btn-outline-primary btn-sm mb-3">
      <i class="fas fa-plus"></i> Add a Place Reminder
    </button>

    <!-- Hidden Form Container -->
    <div id="placeFormContainer" class="card card-body shadow-sm mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Add a Place Reminder</h6>
        <button id="hideFormBtn" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-minus"></i> Hide
        </button>
      </div>
      <form id="placeForm" class="row gx-2 gy-2">
        <div class="col-md-4">
          <label for="itemType" class="form-label">Item</label>
          <select id="itemType" class="form-select" required>
            <option value="">Select Item Type</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="name" class="form-label">Friendly Name</label>
          <input type="text" id="name" class="form-control" placeholder="e.g., Upstairs filter" required />
        </div>
        <div class="col-md-4">
          <label for="lastUpdated" class="form-label">Last Changed</label>
          <input type="date" id="lastUpdated" class="form-control" required />
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Add Reminder</button>
        </div>
      </form>
    </div>

    <div class="alert alert-warning mb-4 d-flex align-items-center" role="alert">
      <span>
        We'll remind you at the next due date. <br/>
        Hit <strong>Done</strong> when you change an item — we’ll set the next due date automatically. <br/>
        <strong>Need a little more time?</strong> Hit the clock to delay the next reminder by 1 month.
      </span>
      <i class="fas fa-house ms-2 text-warning"></i>
    </div>

    <!-- Todoist-style list -->
    <div id="placeList" class="reminder-list"></div>
  </div>

  <!-- Places Logic -->
  <script>
    const airtableApiKey = "patvZfxpDZOYbjS27.dc2df00ca0e49de14030866cf08b05111606b9c79ad1f3d7a436a7bd697617ab";
    const baseId = "appGMW34rQEzsyHbj";
    const placeTable = "place";
    const itemTypesTable = "itemTypes";
    const email = localStorage.getItem("userEmail");

    if (!email) window.location.href = "login.html";

    const apiURL = `https://api.airtable.com/v0/${baseId}/${placeTable}`;
    const itemTypesURL = `https://api.airtable.com/v0/${baseId}/${itemTypesTable}`;
    let itemTypeMap = {}; // { [itemTypeRecordId]: { itemName, intervalMonths } }

    // Helpers
    const qs = (sel) => document.querySelector(sel);
    const listContainer = () => document.getElementById("placeList");

    function showRowMessage(msg) {
      const el = listContainer();
      if (!el) return;
      el.innerHTML = `
        <div class="reminder-item">
          <div class="reminder-row top">
            <div class="reminder-name text-muted">${msg}</div>
            <div class="reminder-date"></div>
          </div>
        </div>
      `;
    }

    function formatDate(val) {
      if (!val) return "—";
      // Accept "YYYY-MM-DD" or ISO with time
      const iso = String(val).includes("T") ? val.split("T")[0] : String(val);
      const [y, m, d] = iso.split("-");
      if (!y || !m || !d) return "—";
      return `${m}-${d}-${y}`;
    }

    function ymd(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function addMonths(isoDateStr, months) {
      if (!isoDateStr) return "";
      const d = new Date(isoDateStr);
      if (isNaN(d)) return "";
      d.setMonth(d.getMonth() + Number(months || 0));
      return ymd(d);
    }

    async function safeFetch(url, options) {
      const res = await fetch(url, options);
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { error: { message: text } }; }
      if (!res.ok) {
        const msg = data?.error?.message || `${res.status} ${res.statusText}`;
        throw new Error(msg);
      }
      return data;
    }

    async function loadItemTypes() {
      try {
        const data = await safeFetch(itemTypesURL, {
          headers: { Authorization: `Bearer ${airtableApiKey}` }
        });
        const dropdown = document.getElementById("itemType");
        if (dropdown) dropdown.innerHTML = '<option value="">Select Item Type</option>';

        (data.records || []).forEach(rec => {
          const id = rec.id;
          const { itemName, intervalMonths } = rec.fields || {};
          if (!itemName) return;
          itemTypeMap[id] = { itemName, intervalMonths };
          if (dropdown) {
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = itemName;
            dropdown.appendChild(opt);
          }
        });
      } catch (err) {
        console.error("itemTypes error:", err);
        // Still let the page work; creation will block if item type invalid
      }
    }

    async function loadPlaces() {
      try {
        showRowMessage("Loading...");
        const filterFormula = `{email} = "${email}"`;
        const data = await safeFetch(`${apiURL}?filterByFormula=${encodeURIComponent(filterFormula)}`, {
          headers: { Authorization: `Bearer ${airtableApiKey}` }
        });

        const el = listContainer();
        if (!el) return;
        el.innerHTML = "";

        const records = (data.records || []).sort((a, b) => {
          const aDate = a.fields?.nextDue ? new Date(a.fields.nextDue) : new Date("9999-12-31");
          const bDate = b.fields?.nextDue ? new Date(b.fields.nextDue) : new Date("9999-12-31");
          return aDate - bDate;
        });

        if (records.length === 0) {
          showRowMessage("No reminders found.");
          return;
        }

        records.forEach(rec => {
          const id = rec.id;
          const { name, lastUpdated, nextDue, itemTypeName } = rec.fields || {};

          // Build options for edit select
          const options = Object.values(itemTypeMap).map(val => {
            const selected = (itemTypeName === val.itemName) ? "selected" : "";
            return `<option value="${val.itemName}" ${selected}>${val.itemName}</option>`;
          }).join("");

          const card = document.createElement("div");
          card.className = "reminder-item";
          card.id = `card-${id}`;

          card.innerHTML = `
            <!-- Read view -->
            <div class="card-view">
              <div class="reminder-row top">
                <div class="reminder-name">${name || ""}</div>
                <div class="reminder-date">${formatDate(nextDue)}</div>
              </div>
              <div class="reminder-row bottom">
                <div class="reminder-type">${itemTypeName || "—"}</div>
                <div class="reminder-actions">
                  <i class="fas fa-check-circle text-primary action-icon" title="Done" onclick="markDone('${id}')"></i>
                  <i class="fas fa-clock text-primary action-icon" title="Delay 1 month" onclick="delayReminder('${id}')"></i>
                  <i class="fas fa-edit text-primary action-icon" title="Edit" onclick="editReminder('${id}')"></i>
                  <i class="fas fa-trash text-danger action-icon" title="Delete" onclick="deleteReminder('${id}')"></i>
                </div>
              </div>
            </div>

            <!-- Edit view -->
            <div class="card-edit">
              <div class="edit-grid">
                <div>
                  <label class="form-label mb-1">Name</label>
                  <input type="text" id="editName-${id}" class="form-control" value="${(name || "").replace(/"/g,'&quot;')}" />
                </div>
                <div>
                  <label class="form-label mb-1">Item Type</label>
                  <select id="editItemType-${id}" class="form-select">${options}</select>
                </div>
                <div>
                  <label class="form-label mb-1">Last Changed</label>
                  <input type="date" id="editLastUpdated-${id}" class="form-control" value="${(lastUpdated || "")}" />
                </div>
                <div>
                  <label class="form-label mb-1">Next Due (auto)</label>
                  <input type="text" class="form-control" value="${formatDate(nextDue)}" disabled />
                </div>
              </div>
              <div class="edit-actions mt-2">
                <button class="btn btn-sm btn-success" onclick="saveEdit('${id}')">Save</button>
                <button class="btn btn-sm btn-secondary" onclick="cancelEdit('${id}')">Cancel</button>
              </div>
            </div>
          `;

          el.appendChild(card);
        });
      } catch (err) {
        console.error("places error:", err);
        showRowMessage(`Couldn’t load reminders: ${err.message}`);
      }
    }

    // Inline edit controls (toggle card state)
    function editReminder(id) {
      document.getElementById(`card-${id}`)?.classList.add("editing");
    }
    function cancelEdit(id) {
      document.getElementById(`card-${id}`)?.classList.remove("editing");
    }

    async function saveEdit(id) {
      try {
        const name = document.getElementById(`editName-${id}`).value.trim();
        const itemTypeName = document.getElementById(`editItemType-${id}`).value;
        const lastUpdated = document.getElementById(`editLastUpdated-${id}`).value;
        const interval = Object.values(itemTypeMap).find(it => it.itemName === itemTypeName)?.intervalMonths;

        if (!interval) {
          alert("Invalid item type selected while editing. Please try again.");
          return;
        }

        const nextDue = addMonths(lastUpdated, interval);

        await safeFetch(`${apiURL}/${id}`, {
          method: "PATCH",
          headers: {
            Authorization: `Bearer ${airtableApiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ fields: { name, itemTypeName, intervalMonths: interval, lastUpdated, nextDue } })
        });

        loadPlaces();
      } catch (err) {
        alert(`Save failed: ${err.message}`);
        console.error(err);
      }
    }

    async function deleteReminder(id) {
      try {
        if (!confirm("Are you sure you want to delete this reminder?")) return;
        await safeFetch(`${apiURL}/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${airtableApiKey}` }
        });
        loadPlaces();
      } catch (err) {
        alert(`Delete failed: ${err.message}`);
        console.error(err);
      }
    }

    async function markDone(id) {
      try {
        const rec = await safeFetch(`${apiURL}/${id}`, {
          headers: { Authorization: `Bearer ${airtableApiKey}` }
        });
        const interval = rec.fields?.intervalMonths || 6;
        const todayISO = ymd(new Date());
        const nextDue = addMonths(todayISO, interval);

        await safeFetch(`${apiURL}/${id}`, {
          method: "PATCH",
          headers: {
            Authorization: `Bearer ${airtableApiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ fields: { lastUpdated: todayISO, nextDue } })
        });
        loadPlaces();
      } catch (err) {
        alert(`Mark done failed: ${err.message}`);
        console.error(err);
      }
    }

    async function delayReminder(id) {
      try {
        const rec = await safeFetch(`${apiURL}/${id}`, {
          headers: { Authorization: `Bearer ${airtableApiKey}` }
        });
        const base = rec.fields?.nextDue ? new Date(rec.fields.nextDue) : new Date();
        base.setMonth(base.getMonth() + 1);
        const delayed = ymd(base);

        await safeFetch(`${apiURL}/${id}`, {
          method: "PATCH",
          headers: {
            Authorization: `Bearer ${airtableApiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ fields: { nextDue: delayed } })
        });
        loadPlaces();
      } catch (err) {
        alert(`Delay failed: ${err.message}`);
        console.error(err);
      }
    }

    // Create handler
    document.getElementById("placeForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        const name = document.getElementById("name").value.trim();
        const itemTypeId = document.getElementById("itemType").value;
        const itemTypeEntry = itemTypeMap[itemTypeId];
        if (!itemTypeEntry) {
          alert("Invalid item type selected. Please try again.");
          return;
        }
        const itemTypeName = itemTypeEntry.itemName;
        const intervalMonths = itemTypeEntry.intervalMonths;
        const lastUpdated = document.getElementById("lastUpdated").value;
        const nextDue = addMonths(lastUpdated, intervalMonths);

        await safeFetch(apiURL, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${airtableApiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            fields: { name, itemTypeName, intervalMonths, lastUpdated, nextDue, email }
          })
        });

        document.getElementById("placeForm").reset();
        loadPlaces();
      } catch (err) {
        alert(`Create failed: ${err.message}`);
        console.error(err);
      }
    });

    // init: load item types, then places (but places also works if item types fail)
    loadItemTypes().finally(loadPlaces);
  </script>

  <!-- Shared menu -->
  <script>
    fetch('menu.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('menu-container').innerHTML = html;
      });
  </script>

  <!-- Toggle form like birthdays -->
  <script>
    document.getElementById("toggleFormBtn").addEventListener("click", function () {
      document.getElementById("placeFormContainer").classList.remove("d-none");
      this.classList.add("d-none");
    });
    document.getElementById("hideFormBtn").addEventListener("click", function () {
      document.getElementById("placeFormContainer").classList.add("d-none");
      document.getElementById("toggleFormBtn").classList.remove("d-none");
    });
  </script>
</body>
</html>
