<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nudgie – Birthdays</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Site styles -->
    <link href="styles.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="favicon.ico">
  </head>
  <body>
    <!-- Nav -->
    <nav class="navbar navbar-expand-sm bg-white border-bottom">
      <div class="container">
        <a class="navbar-brand fw-bold text-brand" href="index.html">Nudgie</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
          aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div id="nav" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
            <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
            <li class="nav-item">
              <button class="btn btn-outline-secondary ms-sm-2" onclick="logout()">Logout</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Loading overlay -->
    <div id="loadingOverlay"
         class="position-fixed top-0 start-0 vw-100 vh-100 d-none
                d-flex flex-column justify-content-center align-items-center
                bg-dark bg-opacity-50 text-white"
         style="z-index: 1055;">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <p class="mt-3 mb-0">Loading your birthdays…</p>
    </div>

    <!-- Main -->
    <main class="pt-2 pt-sm-3 pt-lg-4 pb-5">
      <div class="container">

        <!-- Submenu -->
        <nav class="mb-3" role="navigation" aria-label="Section menu">
          <ul class="nav nav-pills bg-body-tertiary p-1 rounded-3 border">
            <li class="nav-item"><a class="nav-link active" href="dates.html" aria-current="page">Birthdays</a></li>
            <li class="nav-item"><a class="nav-link" href="place.html">Place</a></li>
          </ul>
        </nav>

        <h1 class="fw-semibold mb-3">Birthdays</h1>
        <p class="text-muted">We’ll email you reminders 21 days before, 7 days before, and on the day.</p>

        <!-- Toggle button + form -->
        <button id="toggleFormBtn" class="btn btn-outline-primary btn-sm mb-3">+ Add a Birthday</button>

        <div id="birthdayFormContainer" class="card card-body mb-4 d-none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Add a Birthday</h6>
            <button id="hideFormBtn" class="btn btn-sm btn-outline-secondary">Hide</button>
          </div>
          <form id="birthdayForm" class="row g-2">
            <div class="col-md-4">
              <label for="name" class="form-label">First Name</label>
              <input type="text" id="name" class="form-control" placeholder="First Name" required>
            </div>
            <div class="col-md-4">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" id="lastName" class="form-control" placeholder="Last Name" required>
            </div>
            <div class="col-md-4">
              <label for="date" class="form-label">Birthday</label>
              <input type="date" id="date" class="form-control" required>
            </div>
            <div class="col-12 col-md-4">
              <button type="submit" class="btn btn-primary w-100">Add Birthday</button>
            </div>
          </form>
        </div>

        <!-- List card -->
        <div class="card">
          <div class="card-body">
            <div id="birthdayList" class="vstack gap-2">
              <!-- rows injected here -->
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-top py-3">
      <div class="container text-center text-muted small">
        © <span id="year"></span> Nudgie
      </div>
    </footer>

    <!-- Logic -->
    <script>
      // Footer year
      document.getElementById('year').textContent = new Date().getFullYear();

      // Auth + API config
      const airtableApiKey = "patvZfxpDZOYbjS27.dc2df00ca0e49de14030866cf08b05111606b9c79ad1f3d7a436a7bd697617ab";
      const baseId = "appGMW34rQEzsyHbj";
      const tableName = "birthdays";
      const apiURL = `https://api.airtable.com/v0/${baseId}/${tableName}`;
      const email = localStorage.getItem("userEmail");

      if (!email) {
        window.location.href = "login.html";
      }

      function logout() {
        localStorage.removeItem("userEmail");
        window.location.href = "login.html";
      }

      // Overlay helpers
      function showLoading(){ document.getElementById("loadingOverlay").classList.remove("d-none"); }
      function hideLoading(){ document.getElementById("loadingOverlay").classList.add("d-none"); }

      // Form toggles
      document.getElementById("toggleFormBtn").addEventListener("click", () => {
        document.getElementById("birthdayFormContainer").classList.remove("d-none");
        document.getElementById("toggleFormBtn").classList.add("d-none");
      });
      document.getElementById("hideFormBtn").addEventListener("click", () => {
        document.getElementById("birthdayFormContainer").classList.add("d-none");
        document.getElementById("toggleFormBtn").classList.remove("d-none");
      });

      // Date helpers
      function pad2(n){ return String(n).padStart(2,'0'); }
      const MONS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      function formatDDMonYYYY(d){
        const dd = pad2(d.getDate());
        const mon = MONS[d.getMonth()];
        const yyyy = d.getFullYear();
        return `${dd} ${mon} ${yyyy}`;
      }
      function nextBirthdayDate(iso){
        if(!iso) return null;
        const today = new Date();
        const [y,m,d] = iso.split('-').map(Number);
        const thisYear = new Date(today.getFullYear(), m-1, d);
        const todayTrunc = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        return (thisYear >= todayTrunc) ? thisYear : new Date(today.getFullYear()+1, m-1, d);
      }
      function daysUntilNextBirthday(iso){
        const next = nextBirthdayDate(iso);
        if(!next) return "—";
        const todayTrunc = new Date(new Date().toDateString());
        const diff = Math.round((next - todayTrunc) / (1000*60*60*24));
        if(diff === 0) return "Today";
        if(diff === 1) return "1 day left";
        return `${diff} days left`;
      }

      // Tiny HTML escaper for safety in templating
      function esc(v){
        return String(v ?? '')
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }

      // CRUD
      async function updateBirthday(id){
        const newFirst = document.getElementById(`editFirst-${id}`).value.trim();
        const newLast  = document.getElementById(`editLast-${id}`).value.trim();
        const newDate  = document.getElementById(`editDate-${id}`).value;

        await fetch(`${apiURL}/${id}`,{
          method:"PATCH",
          headers:{
            Authorization:`Bearer ${airtableApiKey}`,
            "Content-Type":"application/json"
          },
          body: JSON.stringify({
            fields: {
              name: newFirst,
              lastName: newLast,
              date: newDate
            }
          })
        });
        loadBirthdays();
      }

      async function deleteBirthday(id){
        if(!confirm("Delete this birthday?")) return;
        await fetch(`${apiURL}/${id}`,{
          method:"DELETE",
          headers:{ Authorization:`Bearer ${airtableApiKey}` }
        });
        loadBirthdays();
      }

      document.getElementById("birthdayForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const name = document.getElementById("name").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const date = document.getElementById("date").value;

        await fetch(apiURL,{
          method:"POST",
          headers:{
            Authorization:`Bearer ${airtableApiKey}`,
            "Content-Type":"application/json"
          },
          body: JSON.stringify({ fields:{ email, name, lastName, date } })
        });

        e.target.reset();
        document.getElementById("hideFormBtn").click(); // collapse form
        loadBirthdays();
      });

      function rowView(record){
        const { name, lastName, date } = record.fields;
        const next = nextBirthdayDate(date);
        const nextDisp = next ? formatDDMonYYYY(next) : "—";
        const actualDisp = date ? formatDDMonYYYY(new Date(date)) : "—";
        const daysLeft = daysUntilNextBirthday(date);
        const id = record.id;

        return `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-brand fw-semibold">${nextDisp}</div>
              <div><strong>${esc(name || "")}</strong> ${esc(lastName || "")}</div>
            </div>
            <div class="text-end">
              <div><i class="bi bi-calendar-event me-1" aria-hidden="true"></i>${actualDisp}</div>
              <div class="text-muted"><i class="bi bi-bell me-1" aria-hidden="true"></i>${daysLeft}</div>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2 justify-content-start">
            <button class="btn btn-sm btn-outline-secondary" onclick="enterEdit('${id}')">Edit</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteBirthday('${id}')">Delete</button>
          </div>
        `;
      }

      function rowEdit(record){
        const { name = "", lastName = "", date = "" } = record.fields;
        const id = record.id;
        return `
          <div class="row g-2">
            <div class="col-12">
              <div class="fw-semibold mb-1">Editing: ${esc(name)} ${esc(lastName)}</div>
            </div>

            <div class="col-12 col-sm-4">
              <label class="form-label">First Name</label>
              <input type="text" id="editFirst-${id}" class="form-control form-control-sm" value="${esc(name)}">
            </div>

            <div class="col-12 col-sm-4">
              <label class="form-label">Last Name</label>
              <input type="text" id="editLast-${id}" class="form-control form-control-sm" value="${esc(lastName)}">
            </div>

            <div class="col-12 col-sm-4">
              <label class="form-label">Birthday</label>
              <input type="date" id="editDate-${id}" class="form-control form-control-sm" value="${date || ""}">
            </div>

            <div class="col-12 col-sm-auto">
              <button class="btn btn-sm btn-success mt-1 mt-sm-0" onclick="updateBirthday('${id}')">Save</button>
              <button class="btn btn-sm btn-secondary ms-1 mt-1 mt-sm-0" onclick="exitEdit('${id}')">Cancel</button>
            </div>
          </div>
        `;
      }

      function enterEdit(id){
        document.getElementById(`viewRow-${id}`).classList.add("d-none");
        document.getElementById(`editRow-${id}`).classList.remove("d-none");
      }
      function exitEdit(id){
        document.getElementById(`editRow-${id}`).classList.add("d-none");
        document.getElementById(`viewRow-${id}`).classList.remove("d-none");
      }

      async function loadBirthdays(){
        showLoading();

        const filter = `email="${email}"`;
        const res = await fetch(`${apiURL}?filterByFormula=${encodeURIComponent(filter)}`, {
          headers:{ Authorization:`Bearer ${airtableApiKey}` }
        });
        const data = await res.json();

        const list = document.getElementById("birthdayList");
        list.innerHTML = "";

        const records = (data.records || []);
        if(records.length === 0){
          list.innerHTML = `<div class="text-muted text-center py-3">No birthdays yet.</div>`;
          hideLoading();
          return;
        }

        // Sort by soonest next birthday
        records.sort((a,b)=>{
          const ad = nextBirthdayDate(a.fields.date) || new Date('9999-12-31');
          const bd = nextBirthdayDate(b.fields.date) || new Date('9999-12-31');
          return ad - bd;
        });

        records.forEach(r=>{
          const wrapper = document.createElement("div");
          wrapper.className = "border rounded p-3";
          wrapper.innerHTML = `
            <div id="viewRow-${r.id}">
              ${rowView(r)}
            </div>
            <div id="editRow-${r.id}" class="d-none">
              ${rowEdit(r)}
            </div>
          `;
          list.appendChild(wrapper);
        });

        hideLoading();
      }

      // Init
      loadBirthdays();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
