<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nudgie - Birthdays</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>

  <!-- Loading Screen -->
  <div id="loadingOverlay">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="loading-text">Loading your birthdaysâ€¦</p>
  </div>

  <!-- Header -->
  <div class="header-bar mb-4">
    <div class="container-narrow px-3 px-sm-4 d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <i class="fas fa-dove"></i>
        <div>
          <h1 class="title mb-0">Nudgie</h1>
          <p class="subtitle mb-0">A smart nudge when you need it</p>
        </div>
      </div>
      <a href="index.html" class="btn btn-outline-primary btn-sm">Home</a>
    </div>
  </div>

  <!-- Main -->
  <main>
    <div class="container-narrow px-3 px-sm-4">

      <div id="menu-container"></div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Birthdays</h2>
      </div>

      <!-- Toggle Button -->
      <button id="toggleFormBtn" class="btn btn-outline-primary btn-sm mb-3">
        <i class="fas fa-plus"></i> Add a Birthday
      </button>
      
      <!-- Hidden Form Container -->
      <div id="birthdayFormContainer" class="card card-body shadow-sm mb-4 d-none" style="background-color: #fff;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">Add a Birthday</h6>
          <button id="hideFormBtn" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-minus"></i> Hide
          </button>
        </div>
        <form id="birthdayForm" class="row gx-2 gy-2">
          <div class="col-md-4">
            <label for="name" class="form-label">First Name</label>
            <input type="text" id="name" class="form-control" placeholder="First Name" required />
          </div>
          <div class="col-md-4">
            <label for="lastName" class="form-label">Last Name</label>
            <input type="text" id="lastName" class="form-control" placeholder="Last Name" required />
          </div>
          <div class="col-md-4">
            <label for="date" class="form-label">Birthday</label>
            <input type="date" id="date" class="form-control" required />
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Add Birthday</button>
          </div>
        </form>
      </div>

      <div class="alert alert-warning mb-4 d-flex align-items-center" role="alert">
        <i class="fas fa-birthday-cake me-2 text-warning"></i>
        <span>We'll email you reminders at 21 days before, 7 days before, and on the day of these birthdays.</span>
      </div>

      <!-- Section card around the list -->
      <div class="section-card">
        <!-- List -->
        <div id="birthdayList" class="reminder-list">
          <!-- rows injected here -->
        </div>
      </div>

    </div>
  </main>

  <!-- Shared Footer -->
  <div id="footer-placeholder"></div>
  <script>
    fetch("footer.html")
      .then(response => response.text())
      .then(data => { document.getElementById("footer-placeholder").innerHTML = data; })
      .catch(err => console.error("Footer load failed:", err));
  </script>

  <!-- Menu include -->
  <script>
    fetch('menu.html')
      .then(res => res.text())
      .then(html => { document.getElementById('menu-container').innerHTML = html; });
  </script>

  <!-- Birthday Logic -->
  <script>
    const airtableApiKey = "patvZfxpDZOYbjS27.dc2df00ca0e49de14030866cf08b05111606b9c79ad1f3d7a436a7bd697617ab";
    const baseId = "appGMW34rQEzsyHbj";
    const tableName = "birthdays";
    const apiURL = `https://api.airtable.com/v0/${baseId}/${tableName}`;
    const email = localStorage.getItem("userEmail");

    if (!email) {
      window.location.href = "login.html";
    }

    function logout() {
      localStorage.removeItem("userEmail");
      window.location.href = "login.html";
    }

    // Loading helpers
    function showLoading() {
      document.getElementById("loadingOverlay").style.display = "flex";
    }
    function hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    // Edit state helpers
    function enterEdit(cardEl) { cardEl.classList.add("editing"); }
    function exitEdit(cardEl)  { cardEl.classList.remove("editing"); }

    async function updateBirthday(id) {
      const newDate = document.getElementById(`editDate-${id}`).value;
      await fetch(`${apiURL}/${id}`, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ fields: { date: newDate } })
      });
      loadBirthdays();
    }

    async function deleteBirthday(id) {
      if (!confirm("Delete this birthday?")) return;
      await fetch(`${apiURL}/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      loadBirthdays();
    }

    document.getElementById("birthdayForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const lastName = document.getElementById("lastName").value.trim();
      const date = document.getElementById("date").value;

      await fetch(apiURL, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ fields: { email, name, lastName, date } })
      });

      document.getElementById("birthdayForm").reset();
      loadBirthdays();
    });

    // ---------- Helpers to compute and format "next birthday" & days left ----------
    function pad2(n){ return String(n).padStart(2,'0'); }
    const MONS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function formatDDMonYYYY(d){
      const dd = pad2(d.getDate());
      const mon = MONS[d.getMonth()];
      const yyyy = d.getFullYear();
      return `${dd} ${mon} ${yyyy}`;
    }

    // Return the Date object for the next birthday occurrence given ISO "YYYY-MM-DD"
    function nextBirthdayDate(iso) {
      if (!iso) return null;
      const today = new Date();
      const [y, m, d] = iso.split('-').map(Number);
      const thisYear = new Date(today.getFullYear(), (m-1), d);
      const todayTrunc = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      return (thisYear >= todayTrunc) ? thisYear : new Date(today.getFullYear()+1, (m-1), d);
    }

    // Display string like "123 days left"
    function daysUntilNextBirthday(iso) {
      const next = nextBirthdayDate(iso);
      if (!next) return "â€”";
      const today = new Date();
      const todayTrunc = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const msPerDay = 1000 * 60 * 60 * 24;
      const diff = Math.round((next - todayTrunc) / msPerDay);
      if (diff === 0) return "Today ðŸŽ‰";
      if (diff === 1) return "1 day left";
      return `${diff} days left`;
    }

    // Given ISO "YYYY-MM-DD", return formatted next occurrence in DD Mon YYYY
    function nextBirthdayDisplay(iso) {
      const next = nextBirthdayDate(iso);
      return next ? formatDDMonYYYY(next) : "â€”";
    }

    async function loadBirthdays() {
      showLoading();

      const filterFormula = `email="${email}"`;
      const res = await fetch(`${apiURL}?filterByFormula=${encodeURIComponent(filterFormula)}`, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      const data = await res.json();

      const list = document.getElementById("birthdayList");
      list.innerHTML = "";

      if (!data.records || data.records.length === 0) {
        list.innerHTML = `<div class="text-muted text-center py-3">No birthdays found.</div>`;
        hideLoading();
        return;
      }

      // Sort by nextReminderISO (soonest first; empties last)
      data.records.sort((a, b) => {
        const aISO = a.fields.nextReminderISO;
        const bISO = b.fields.nextReminderISO;
        const aDate = aISO ? new Date(aISO) : new Date('9999-12-31');
        const bDate = bISO ? new Date(bISO) : new Date('9999-12-31');
        return aDate - bDate;
      });

      data.records.forEach(record => {
        const { name, lastName, date, birthdayDisplay } = record.fields;
        const id = record.id;

        // Displays
        const actualBirthdayDisplay = birthdayDisplay || "â€”"; // original birthday (DD Mon YYYY precomputed if you store it)
        const nextBday = nextBirthdayDisplay(date);            // DD Mon YYYY
        const daysLeftLbl = daysUntilNextBirthday(date);       // "XX days left" / "Today ðŸŽ‰" / "â€”"

        const card = document.createElement("div");
        card.className = "reminder-item";
        card.id = `card-${id}`;

        card.innerHTML = `
          <div class="card-view">
            <div class="row-top d-flex justify-content-between align-items-start">
              <!-- LEFT: next birthday (purple) + name underneath -->
              <div class="left-col">
                <div class="birthday-date">${nextBday}</div>
                <div class="reminder-title" style="font-weight: 400;">
                  <strong>${name || ""}</strong> <span class="last-name">${lastName || ""}</span>
                </div>
              </div>

              <!-- RIGHT: Actual birthday + days left + kebab -->
              <div class="d-flex align-items-start gap-2">
                <div class="meta-stack me-2 text-end">
                  <div class="actual-bday">
                    <i class="fa-solid fa-cake-candles me-1"></i>${actualBirthdayDisplay}
                  </div>
                  <div class="text-muted">
                    <i class="fa-regular fa-bell me-1"></i>${daysLeftLbl}
                  </div>
                </div>
                <div class="dropdown">
                  <button class="kebab-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Actions">
                    <i class="fa-solid fa-ellipsis-vertical kebab-icon"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><button class="dropdown-item" onclick="enterEdit(document.getElementById('card-${id}'))"><i class="fa-solid fa-pen me-2"></i>Edit</button></li>
                    <li><button class="dropdown-item text-danger" onclick="deleteBirthday('${id}')"><i class="fa-solid fa-trash me-2"></i>Delete</button></li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Edit panel -->
            <div class="card-edit">
              <div class="edit-grid">
                <div>
                  <label class="form-label">Birthday</label>
                  <input type="date" id="editDate-${id}" class="form-control form-control-sm" value="${date || ""}" />
                </div>
              </div>
              <div class="edit-actions">
                <button class="btn btn-sm btn-success" onclick="updateBirthday('${id}')">Save</button>
                <button class="btn btn-sm btn-secondary" onclick="exitEdit(document.getElementById('card-${id}'))">Cancel</button>
              </div>
            </div>
          </div>
        `;

        list.appendChild(card);
      });

      hideLoading();
    }

    loadBirthdays();
  </script>

  <!-- Form toggle -->
  <script>
    document.getElementById("toggleFormBtn").addEventListener("click", function () {
      document.getElementById("birthdayFormContainer").classList.remove("d-none");
      this.classList.add("d-none");
    });
    document.getElementById("hideFormBtn").addEventListener("click", function () {
      document.getElementById("birthdayFormContainer").classList.add("d-none");
      document.getElementById("toggleFormBtn").classList.remove("d-none");
    });
  </script>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
