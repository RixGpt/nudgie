
   <!-- ===== CONFIG =====
    // const AIRTABLE_TOKEN = 'pat7FJIZ2jVBPvyFJ.f3f48877944f4a6e2ac0d591468113c051dce38e080d11a4821c37151c5d6a9b'; // replace
    // const AIRTABLE_BASE = 'appDw2ve8ICnaUL6g'; // replace
    // const BDAY_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE}/birthdays`; -->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nudgie ‚Äî Birthdays</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .nudgie-container { max-width:820px; }
    .brand { font-weight:700; letter-spacing:0.2px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container nudgie-container py-2 d-flex justify-content-between align-items-center">
      <a class="navbar-brand brand" href="index.html">Nudgie</a>
      <div class="d-flex gap-3">
        <a class="nav-link" href="about.html">About</a>
        <a class="nav-link" href="contact.html">Contact</a>
        <button class="btn btn-outline-secondary btn-sm" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container nudgie-container py-4">
    <div class="row g-3">
      <div class="col-12 d-flex justify-content-between align-items-end">
        <div>
          <h1 class="h4 mb-1">Birthdays</h1>
          <p class="text-muted mb-0">Add, edit, and see upcoming birthdays.</p>
        </div>
        <a class="btn btn-primary" href="login.html" id="loginCta" style="display:none;">Log in</a>
      </div>

      <!-- Add form -->
      <div class="col-12" id="addWrap" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-body">
            <form id="addForm" class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">First name</label>
                <input id="firstName" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">Last name</label>
                <input id="lastName" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Date of birth</label>
                <input id="dob" type="date" class="form-control" required>
              </div>
              <div class="col-md-1">
                <button class="btn btn-primary w-100" type="submit">+</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- List -->
      <div class="col-12" id="listWrap" style="display:none;">
        <div class="card shadow-sm">
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th style="width:140px;">Birthday</th>
                  <th style="width:160px;">Next birthday</th>
                  <th style="width:80px;">Age</th>
                  <th style="width:130px;" class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div class="col-12" id="emptyState" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-body text-center text-muted">
            <div class="mb-2">No birthdays yet.</div>
            <div>Add one above to get started. üéÇ</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit birthday</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm" class="row g-2">
            <input type="hidden" id="editId">
            <div class="col-md-6">
              <label class="form-label small text-muted mb-1">First name</label>
              <input id="editFirst" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted mb-1">Last name</label>
              <input id="editLast" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted mb-1">Date of birth</label>
              <input id="editDob" type="date" class="form-control" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEdit">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== CONFIG (replace) =====
    const AIRTABLE_TOKEN = 'pat7FJIZ2jVBPvyFJ.f3f48877944f4a6e2ac0d591468113c051dce38e080d11a4821c37151c5d6a9b'; // replace
    const AIRTABLE_BASE  = 'appDw2ve8ICnaUL6g'; // replace
    const BDAY_URL       = `https://api.airtable.com/v0/${AIRTABLE_BASE}/birthdays`;
    const headers = { Authorization: `Bearer ${AIRTABLE_TOKEN}`, 'Content-Type': 'application/json' };

    // ===== Session helpers =====
    function getSession(){ try { return JSON.parse(localStorage.getItem('nudgie_session')||'null'); } catch(_){ return null; } }
    function ensureLogin(){
      const s = getSession();
      const addWrap = document.getElementById('addWrap');
      const listWrap = document.getElementById('listWrap');
      const loginCta = document.getElementById('loginCta');
      if(!s){ loginCta.style.display='inline-block'; return null; }
      addWrap.style.display=''; listWrap.style.display=''; return s;
    }
    document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('nudgie_session'); location.href = 'login.html'; });

    // ===== Date helpers (handle ISO or Y-M-D, avoid TZ drift) =====
    function pad(n){ return String(n).padStart(2,'0'); }
    function toYMD(date){ return date.getFullYear()+'-'+pad(date.getMonth()+1)+'-'+pad(date.getDate()); }
    function normalizeYMD(v){
      if(!v) return '';
      if (typeof v === 'string') {
        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;      // already Y-M-D
        if (v.includes('T')) return v.substring(0,10);     // ISO -> Y-M-D
      }
      const d = new Date(v);
      return isNaN(d) ? '' : toYMD(d);
    }
    function parseYMD(ymd){ if(!ymd) return null; const [y,m,d]=ymd.split('-').map(Number); return new Date(y, m-1, d); }
    function fmtDateYMD(ymd){
      const d = parseYMD(ymd); if(!d) return '';
      return d.toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' });
    }
    function ageTurningFromYMD(dobYMD, nextYMD){
      const dob = parseYMD(dobYMD), nb = parseYMD(nextYMD);
      if(!dob || !nb) return '';
      return nb.getFullYear() - dob.getFullYear();
    }

    // ===== Airtable helpers =====
    async function fetchMine(email){
      const filter = "LOWER({user_email})='" + email.toLowerCase() + "'";
      const url = BDAY_URL + "?filterByFormula=" + encodeURIComponent(filter) + "&pageSize=100";
      const res = await fetch(url, { headers: { Authorization: "Bearer " + AIRTABLE_TOKEN } });
      const data = await res.json();
      return data.records || [];
    }
    async function createRec(fields){
      const res = await fetch(BDAY_URL, { method:'POST', headers, body: JSON.stringify({ fields }) });
      return res.json();
    }
    async function patchRec(id, fields){
      const res = await fetch(BDAY_URL + "/" + id, { method:'PATCH', headers, body: JSON.stringify({ fields }) });
      return res.json();
    }
    async function deleteRec(id){
      await fetch(BDAY_URL + "/" + id, { method:'DELETE', headers:{ Authorization: "Bearer " + AIRTABLE_TOKEN } });
    }

    // ===== Render =====
    const tbody = document.getElementById('tbody');
    function renderRows(rows){
      tbody.innerHTML = '';
      rows.forEach(rec => {
        const f = rec.fields || {};
        const name = ((f.first_name||'') + ' ' + (f.last_name||'')).trim();
        const dobY = normalizeYMD(f.date || '');
        const nbY  = normalizeYMD(f.next_birthday || ''); // comes from your Airtable ISO formula
        const age  = dobY && nbY ? ageTurningFromYMD(dobY, nbY) : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${name}</td>
          <td>${fmtDateYMD(dobY)}</td>
          <td>${fmtDateYMD(nbY)}</td>
          <td>${age}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-secondary me-1" data-action="edit">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-outline-danger" data-action="del">X</button>
          </td>`;

        tr.querySelector('[data-action="edit"]').addEventListener('click', ()=> openEdit(rec));
        tr.querySelector('[data-action="del"]').addEventListener('click', async ()=>{
          if(confirm('Delete this birthday?')){ await deleteRec(rec.id); await load(); }
        });

        tbody.appendChild(tr);
      });
    }

    // ===== Edit modal logic =====
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    function openEdit(rec){
      const f = rec.fields||{};
      document.getElementById('editId').value = rec.id;
      document.getElementById('editFirst').value = f.first_name||'';
      document.getElementById('editLast').value  = f.last_name||'';
      document.getElementById('editDob').value   = normalizeYMD(f.date||'');
      editModal.show();
    }
    document.getElementById('saveEdit').addEventListener('click', async ()=>{
      const id    = document.getElementById('editId').value;
      const first = document.getElementById('editFirst').value.trim();
      const last  = document.getElementById('editLast').value.trim();
      const dob   = document.getElementById('editDob').value; // YYYY-MM-DD
      // Do NOT set next_birthday here ‚Äî Airtable formula handles it
      await patchRec(id, { first_name:first, last_name:last, date:dob });
      editModal.hide();
      await load();
    });

    // ===== Add flow =====
    document.getElementById('addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const s = getSession(); if(!s) return;
      const first = document.getElementById('firstName').value.trim();
      const last  = document.getElementById('lastName').value.trim();
      const dob   = document.getElementById('dob').value; // YYYY-MM-DD
      // Do NOT set next_birthday ‚Äî Airtable formula handles it
      await createRec({ user_email: s.email, first_name:first, last_name:last, date:dob });
      e.target.reset();
      await load();
    });

    // ===== Load & init =====
    async function load(){
      const s = getSession();
      const empty = document.getElementById('emptyState');
      const listWrap = document.getElementById('listWrap');
      if(!s) return;

      let rows = await fetchMine(s.email);

      // Sort by next_birthday ascending (handles ISO or Y-M-D)
      rows = rows.sort((a,b)=>{
        const ay = normalizeYMD(a.fields.next_birthday || '2100-01-01');
        const by = normalizeYMD(b.fields.next_birthday || '2100-01-01');
        return parseYMD(ay) - parseYMD(by);
      });

      if(rows.length===0){ empty.style.display=''; listWrap.style.display='none'; }
      else { empty.style.display='none'; listWrap.style.display=''; renderRows(rows); }
    }

    (async function init(){
      const s = ensureLogin();
      if(!s) return;
      await load();
    })();
  </script>
</body>
</html>
