<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nudgie â€” Birthdays</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    :root{
      --ink:#0f172a;
      --muted:#475569;
      --border: rgba(15, 23, 42, 0.12);
    }

    body { background:#f8f9fa; color:var(--ink); }
    .nudgie-container { max-width:820px; }
    .brand { font-weight:800; letter-spacing:.2px; }

    .bday-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:1.25rem;
      padding:1.25rem;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
    }

    .bday-topdate{
      font-size:.95rem;
      color:#6b7280;
      margin-bottom:.5rem;
    }

    .bday-name{
      font-weight:800;
      letter-spacing:-.01em;
      margin-bottom:.25rem;
    }

    .bday-meta{
      color:#6b7280;
      margin:0;
    }

    .icon-btn{
      width:40px;
      height:40px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }

    .icon-btn .bi{
      font-size:1.05rem;
      line-height:1;
    }
  </style>
</head>

<body>
  <!-- Nav -->
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container nudgie-container py-2 d-flex justify-content-between align-items-center">
      <a class="navbar-brand brand" href="index.html">Nudgie</a>
      <div class="d-flex gap-3 align-items-center">
        <a class="nav-link" href="about.html">About</a>
        <a class="nav-link" href="contact.html">Contact</a>
        <button class="btn btn-outline-secondary btn-sm" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container nudgie-container py-4">
    <div class="d-flex justify-content-between align-items-end mb-3">
      <div>
        <h1 class="h4 mb-1">Birthdays</h1>
        <p class="text-muted mb-0">Add, edit, and track upcoming birthdays.</p>
        <p class="text-muted mb-0">Have a lot of birthdays to enter? <a href="contact.html">Send us the list in any format</a> and we'll do it for you.</p>
      </div>
    </div>

    <!-- Add form -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <form id="addForm" class="row g-2 align-items-end">
          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">First name</label>
            <input id="firstName" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">Last name</label>
            <input id="lastName" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted mb-1">Date of birth</label>
            <input id="dob" type="date" class="form-control" required>
          </div>
          <div class="col-md-1">
            <button class="btn btn-primary w-100" type="submit">+</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Cards -->
    <div id="cards" class="d-grid gap-3"></div>

    <!-- Empty -->
    <div id="emptyState" class="card shadow-sm text-center text-muted" style="display:none;">
      <div class="card-body">
        No birthdays yet. Add one above ðŸŽ‚
      </div>
    </div>
  </main>

  <!-- Edit modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit birthday</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editId">
          <div class="mb-2">
            <label class="form-label small">First name</label>
            <input id="editFirst" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label small">Last name</label>
            <input id="editLast" class="form-control">
          </div>
          <div>
            <label class="form-label small">Date of birth</label>
            <input id="editDob" type="date" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="saveEdit">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /***** CONFIG â€” replace with yours *****/
    const AIRTABLE_TOKEN = 'patvZfxpDZOYbjS27.dc2df00ca0e49de14030866cf08b05111606b9c79ad1f3d7a436a7bd697617ab';
    const AIRTABLE_BASE  = 'appGMW34rQEzsyHbj';
    const TABLE_NAME    = 'birthdays';
    const API_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE}/${TABLE_NAME}`;
    const headers = { Authorization:`Bearer ${AIRTABLE_TOKEN}`, 'Content-Type':'application/json' };

    const cards = document.getElementById('cards');
    const emptyState = document.getElementById('emptyState');
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    function session(){
      try { return JSON.parse(localStorage.getItem('nudgie_session')); }
      catch { return null; }
    }

    function ordinal(n){
      const s=["th","st","nd","rd"], v=n%100;
      return n+(s[(v-20)%10]||s[v]||s[0]);
    }

    function prettyDate(d){
      const dt = new Date(d);
      return `${ordinal(dt.getDate())} of ${dt.toLocaleString('default',{month:'long'})} ${dt.getFullYear()}`;
    }

    function daysUntil(d){
      const today = new Date();
      const target = new Date(d);
      return Math.max(0, Math.round((target - today)/(1000*60*60*24)));
    }

    async function fetchBirthdays(){
      const s = session();
      const filter = `LOWER({user_email})='${s.email.toLowerCase()}'`;
      const res = await fetch(`${API_URL}?filterByFormula=${encodeURIComponent(filter)}`, { headers });
      const data = await res.json();
      return data.records || [];
    }

    function render(rows){
      cards.innerHTML='';
      if(!rows.length){
        emptyState.style.display='';
        return;
      }
      emptyState.style.display='none';

      rows.forEach(r=>{
        const f = r.fields;
        const name = `${f.first_name||''} ${f.last_name||''}`.trim();
        const el = document.createElement('div');
        el.className='bday-card';

        el.innerHTML = `
          <div class="d-flex justify-content-between gap-3">
            <div>
              <div class="bday-topdate">${prettyDate(f.date)}</div>
              <div class="h4 bday-name">${name}'s Birthday</div>
              <p class="bday-meta">Next birthday: ${prettyDate(f.next_birthday)}</p>
              <p class="bday-meta">Days to go: ${daysUntil(f.next_birthday)} days</p>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary icon-btn" data-edit>
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger icon-btn" data-del>
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;

        el.querySelector('[data-edit]').onclick = ()=>{
          editId.value=r.id;
          editFirst.value=f.first_name||'';
          editLast.value=f.last_name||'';
          editDob.value=f.date;
          editModal.show();
        };

        el.querySelector('[data-del]').onclick = async ()=>{
          if(confirm('Delete this birthday?')){
            await fetch(`${API_URL}/${r.id}`, { method:'DELETE', headers });
            load();
          }
        };

        cards.appendChild(el);
      });
    }

    async function load(){
      const rows = await fetchBirthdays();
      render(rows);
    }

    addForm.onsubmit = async e=>{
      e.preventDefault();
      const s = session();
      await fetch(API_URL,{
        method:'POST',
        headers,
        body:JSON.stringify({
          fields:{
            user_email:s.email,
            first_name:firstName.value,
            last_name:lastName.value,
            date:dob.value
          }
        })
      });
      addForm.reset();
      load();
    };

    saveEdit.onclick = async ()=>{
      await fetch(`${API_URL}/${editId.value}`,{
        method:'PATCH',
        headers,
        body:JSON.stringify({
          fields:{
            first_name:editFirst.value,
            last_name:editLast.value,
            date:editDob.value
          }
        })
      });
      editModal.hide();
      load();
    };

    logoutBtn.onclick = ()=>{
      localStorage.removeItem('nudgie_session');
      location.href='login.html';
    };

    load();
  </script>
</body>
</html>
