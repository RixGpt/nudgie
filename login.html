<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nudgie – Login</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Site styles (same file as homepage) -->
    <link href="styles.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="favicon.ico">
  </head>
  <body>
    <!-- Nav -->
    <nav class="navbar navbar-expand-sm bg-white border-bottom">
      <div class="container">
        <a class="navbar-brand fw-bold text-brand" href="index.html">Nudgie</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
          aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div id="nav" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
            <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
            <li class="nav-item"><a class="btn btn-primary ms-sm-2" href="login.html" aria-current="page">Login</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Login (same two-column layout as hero) -->
    <main class="py-5">
      <div class="container">
        <div class="row align-items-center">
          <!-- Left: copy + form -->
          <div class="col-lg-6 mb-4 mb-lg-0">
            <h1 class="fw-semibold mb-2">Login or Sign Up</h1>
            <p class="text-muted mb-4">Never miss a special date or maintenance item again.</p>

            <form id="authForm" class="border p-4 bg-white rounded">
              <div class="mb-3">
                <label for="email" class="form-label">Email address</label>
                <input type="email" id="email" class="form-control" placeholder="you@example.com" required />
              </div>
              <div class="mb-3">
                <label for="pin" class="form-label">4-digit PIN</label>
                <input
                  type="text"
                  id="pin"
                  class="form-control"
                  pattern="\\d{4}"
                  inputmode="numeric"
                  maxlength="4"
                  placeholder="1234"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary w-100">Login / Sign Up</button>
              <p id="message" class="text-danger mt-3 text-center"></p>
            </form>
          </div>

          <!-- Right: image (same hero image sizing) -->
          <div class="col-lg-6 text-center">
            <img src="hero.png" class="img-fluid hero-img" alt="Illustration of reminders" />
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-top py-3">
      <div class="container text-center text-muted small">
        © <span id="year"></span> Nudgie
      </div>
    </footer>

    <script>
      // Year in footer
      document.getElementById('year').textContent = new Date().getFullYear();

      // --- Airtable auth logic (unchanged; consider moving the key to a safer place before launch) ---
      const AIRTABLE_API_KEY = "patvZfxpDZOYbjS27.dc2df00ca0e49de14030866cf08b05111606b9c79ad1f3d7a436a7bd697617ab";
      const AIRTABLE_BASE_ID = "appGMW34rQEzsyHbj";
      const AIRTABLE_TABLE_NAME = "users";

      async function fetchUser(email) {
        const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?filterByFormula=LOWER(email)%3D'${email.toLowerCase()}'`;
        const resp = await fetch(url, {
          headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` },
        });
        const data = await resp.json();
        return data.records || [];
      }

      async function createUser(email, pin) {
        const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`;
        const resp = await fetch(url, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${AIRTABLE_API_KEY}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ fields: { email, pin } }),
        });
        return resp.ok;
      }

      document.getElementById("authForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const email = document.getElementById("email").value.trim();
        const pin = document.getElementById("pin").value.trim();
        const msg = document.getElementById("message");
        msg.textContent = "";

        try {
          const users = await fetchUser(email);
          if (users.length > 0) {
            const storedPin = String(users[0].fields.pin || "");
            if (storedPin === pin) {
              localStorage.setItem("userEmail", email);
              window.location.href = "dates.html";
            } else {
              msg.textContent = "Incorrect PIN. Try again.";
            }
          } else {
            const success = await createUser(email, pin);
            if (success) {
              localStorage.setItem("userEmail", email);
              window.location.href = "dates.html";
            } else {
              msg.textContent = "Signup failed. Try again.";
            }
          }
        } catch (error) {
          console.error(error);
          msg.textContent = "Something went wrong. Try again.";
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>


