<!DOCTYPE html>
<html>
<head>
  <title>RemindMe - Dates</title>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css">
</head>
<body>
  <header>
    <h2>üéÇ Your Birthday Reminders</h2>
    <button onclick="logout()">Logout</button>
  </header>

  <main class="container">
    <form id="birthdayForm">
      <input type="text" id="name" placeholder="Name" required />
      <input type="date" id="date" required />
      <button type="submit">Add Birthday</button>
    </form>

    <hr/>

    <ul id="birthdayList"></ul>
  </main>

  <script>
    const airtableApiKey = "patvZfxpDZOYbjS27.dc2df00ca0e49de14030866cf08b05111606b9c79ad1f3d7a436a7bd697617ab"; // TEMP ‚Äî hide before launch
    const baseId = "appGMW34rQEzsyHbj"; // ‚úÖ Your actual Base ID
    const tableName = "birthdays";
    const apiURL = `https://api.airtable.com/v0/${baseId}/${tableName}`;
    const email = localStorage.getItem("userEmail");

    if (!email) {
      window.location.href = "login.html";
    }

    function logout() {
      localStorage.removeItem("userEmail");
      window.location.href = "login.html";
    }

    function editBirthday(id) {
      document.getElementById(`view-${id}`).style.display = "none";
      document.getElementById(`editForm-${id}`).style.display = "inline";
    }

    function cancelEdit(id) {
      document.getElementById(`view-${id}`).style.display = "inline";
      document.getElementById(`editForm-${id}`).style.display = "none";
    }

    async function updateBirthday(id, newDate) {
      await fetch(`${apiURL}/${id}`, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fields: {
            date: newDate
          }
        })
      });
      loadBirthdays();
    }

    async function loadBirthdays() {
      const filterFormula = `email="${email}"`;
      console.log("Using filter formula:", filterFormula);

      const res = await fetch(`${apiURL}?filterByFormula=${encodeURIComponent(filterFormula)}`, {
        headers: {
          Authorization: `Bearer ${airtableApiKey}`
        }
      });

      const data = await res.json();
      console.log("Airtable response:", data);

      const list = document.getElementById("birthdayList");
      list.innerHTML = "";

      if (!data.records || data.records.length === 0) {
        list.innerHTML = "<li>No birthdays found.</li>";
        return;
      }

      data.records.forEach(record => {
        const { name, date } = record.fields;
        const id = record.id;

        const li = document.createElement("li");
        li.innerHTML = `
          <span id="view-${id}">${name} ‚Äî ${date}</span>
          <form id="editForm-${id}" style="display:none;">
            <input type="date" id="editDate-${id}" value="${date}" />
            <button type="submit">üíæ</button>
            <button type="button" onclick="cancelEdit('${id}')">Cancel</button>
          </form>
          <button onclick="editBirthday('${id}')">‚úèÔ∏è</button>
          <button onclick="deleteBirthday('${id}')">‚ùå</button>
        `;
        list.appendChild(li);

        document.getElementById(`editForm-${id}`).addEventListener("submit", function (e) {
          e.preventDefault();
          const newDate = document.getElementById(`editDate-${id}`).value;
          updateBirthday(id, newDate);
        });
      });
    }

    async function deleteBirthday(id) {
      await fetch(`${apiURL}/${id}`, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`
        }
      });
      loadBirthdays();
    }

    document.getElementById("birthdayForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const date = document.getElementById("date").value;

      await fetch(apiURL, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fields: {
            email,
            name,
            date
          }
        })
      });

      document.getElementById("birthdayForm").reset();
      loadBirthdays();
    });

    loadBirthdays();
  </script>
</body>
</html>
