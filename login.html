<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nudgie â€” Login</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a;
      --muted:#6c757d;
      --soft:#f8f9fa;
      --border: rgba(15, 23, 42, 0.12);
    }

    body { background: var(--soft); color: var(--ink); }
    a { text-decoration: none; }
    a:hover { text-decoration: underline; }

    .nudgie-container { max-width: 860px; } /* matches your app pages better than 720 */
    .brand { font-weight: 800; letter-spacing: 0.2px; }

    /* App page header band (matches Birthdays) */
    .page-head{
      background: var(--soft);
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    .page-title{
      font-weight: 800;
      letter-spacing: -0.02em;
      margin: 0;
    }

    .page-subtitle{
      color: var(--muted);
      margin: 0.25rem 0 0;
      font-size: 1.15rem;
    }

    /* Reusable small section title (matches your Birthdays section header style) */
    .section-title{
      font-size: 1.15rem;
      font-weight: 800;
      letter-spacing: -0.01em;
    }

    .icon-btn{
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
  </style>
</head>

<body>
  <!-- Top nav (same style as other pages) -->
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container nudgie-container py-2">
      <a class="navbar-brand brand" href="index.html">Nudgie</a>
      <div class="d-flex gap-3">
        <a class="nav-link" href="about.html">About</a>
        <a class="nav-link" href="contact.html">Contact</a>
      </div>
    </div>
  </nav>

  <!-- Page header band (like Birthdays) -->
  <header class="page-head">
    <div class="container nudgie-container py-4">
      <h1 class="display-4 page-title">Login</h1>
      <p class="page-subtitle">Use your email and a 4â€“6 digit PIN. First time? Weâ€™ll create your account.</p>
    </div>
  </header>

  <main class="container nudgie-container py-4">
    <div class="row g-4">

      <!-- Login Card -->
      <div class="col-12">
        <div class="card shadow-sm border border-secondary-subtle">
          <div class="card-body">
            <h2 class="section-title mb-2">Log in / Sign up</h2>
            <p class="text-muted small mb-3">We keep it simple: email + PIN. No passwords to forget.</p>

            <form id="loginForm" class="row g-2 align-items-end">
              <div class="col-md-7">
                <label for="email" class="form-label small text-muted mb-1">Email</label>
                <input id="email" type="email" class="form-control" placeholder="you@example.com" required>
              </div>

              <div class="col-md-5">
                <label for="pin" class="form-label small text-muted mb-1">PIN</label>
                <input
                  id="pin"
                  type="password"
                  inputmode="numeric"
                  pattern="[0-9]{4,6}"
                  minlength="4"
                  maxlength="6"
                  class="form-control"
                  placeholder="â€¢â€¢â€¢â€¢"
                  required
                >
              </div>

              <div class="col-12 d-flex align-items-center gap-2 mt-2">
                <button class="btn btn-primary" type="submit">Continue</button>
                <button id="forgotBtn" class="btn btn-link" type="button">Forgot PIN?</button>
              </div>

              <div class="col-12 small text-muted mt-2">By continuing you agree to be gently nudged. ðŸ’œ</div>
            </form>
          </div>
        </div>
      </div>

      <!-- Reset Card -->
      <div class="col-12 d-none" id="resetCard">
        <div class="card bg-light border border-secondary-subtle shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h2 class="section-title mb-0">Reset your PIN</h2>
              <button class="btn btn-sm btn-outline-secondary" id="closeReset" type="button">Close</button>
            </div>

            <hr class="mt-2 mb-3 border-secondary-subtle">

            <p class="small text-muted mb-3">We emailed you a 6-digit code. It expires in 15 minutes.</p>

            <form id="resetForm" class="row g-2 align-items-end">
              <div class="col-md-5">
                <label class="form-label small text-muted mb-1">Email</label>
                <input id="resetEmail" type="email" class="form-control" placeholder="you@example.com" required>
              </div>

              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Code</label>
                <input id="resetCode" type="text" class="form-control" placeholder="123456" maxlength="6" required>
              </div>

              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">New PIN</label>
                <input
                  id="newPin"
                  type="password"
                  inputmode="numeric"
                  pattern="[0-9]{4,6}"
                  minlength="4"
                  maxlength="6"
                  class="form-control"
                  placeholder="â€¢â€¢â€¢â€¢"
                  required
                >
              </div>

              <div class="col-md-1">
                <button class="btn btn-primary w-100" type="submit">Go</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Toasts -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">Nudgie</strong>
        <small class="text-muted">now</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody">Hello</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== CONFIG =====
    const AIRTABLE_TOKEN = 'pat7FJIZ2jVBPvyFJ.f3f48877944f4a6e2ac0d591468113c051dce38e080d11a4821c37151c5d6a9b';
    const AIRTABLE_BASE  = 'appDw2ve8ICnaUL6g';
    const USERS_URL      = `https://api.airtable.com/v0/${AIRTABLE_BASE}/users`;
    const MAILER_URL     = 'https://script.google.com/macros/s/AKfycbzdMtKfQVmt5AyYcaLxno1GDDlbGmRaVDbjP8A8hisQVNhoy7gaquRZceWxaQ0to59tzQ/exec';

    // ===== Utils =====
    function showToast(title, body){
      document.getElementById('toastTitle').textContent = title || 'Nudgie';
      document.getElementById('toastBody').textContent = body || '';
      const t = new bootstrap.Toast(document.getElementById('toast'));
      t.show();
    }

    async function sha256(str){
      const buf = new TextEncoder().encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', buf);
      return [...new Uint8Array(hashBuffer)]
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    function setSession(email){
      localStorage.setItem('nudgie_session', JSON.stringify({ email, issued_at: Date.now() }));
    }

    // ===== Airtable helpers =====
    async function fetchUser(email){
      const filter = "LOWER({email})='" + email.toLowerCase().replace("'", "\\'") + "'";
      const url = USERS_URL + "?filterByFormula=" + encodeURIComponent(filter) + "&maxRecords=1";
      const res = await fetch(url, { headers: { Authorization: "Bearer " + AIRTABLE_TOKEN } });
      const data = await res.json();
      return (data.records || [])[0] || null;
    }

    async function patchUser(recId, fields){
      const res = await fetch(USERS_URL + "/" + recId, {
        method: 'PATCH',
        headers: {
          Authorization: "Bearer " + AIRTABLE_TOKEN,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ fields })
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = text; }

      if (!res.ok) {
        console.error('Airtable PATCH error:', res.status, data);
        throw new Error('Airtable update failed: ' + res.status);
      }
      return data;
    }

    async function createUser(email, pin){
      const pin_hash = await sha256(pin);
      const res = await fetch(USERS_URL, {
        method: 'POST',
        headers: {
          Authorization: "Bearer " + AIRTABLE_TOKEN,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ fields: { email, pin_hash } })
      });
      const data = await res.json();
      if(!data.id) {
        console.error('Signup error:', data);
        throw new Error('Signup failed');
      }
      return data;
    }

    // ===== Login / Signup =====
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const pin   = document.getElementById('pin').value.trim();

      try {
        let rec = await fetchUser(email);
        const hash = await sha256(pin);

        if(!rec) { // SIGN UP
          await createUser(email, pin);
          rec = await fetchUser(email);
        }

        if((rec.fields.pin_hash || '') !== hash){
          showToast('Login failed', 'Wrong PIN.');
          return;
        }

        setSession(email);
        showToast('Welcome', 'You are now logged in.');
        setTimeout(() => { window.location.href = 'birthdays.html'; }, 600);

      } catch(err){
        console.error('Login error:', err);
        showToast('Error', 'Please try again.');
      }
    });

    // ===== Forgot PIN (send code) =====
    const resetCard = document.getElementById('resetCard');

    document.getElementById('forgotBtn').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) {
        showToast('Forgot PIN', 'Enter your email first.');
        return;
      }

      try {
        await fetch(MAILER_URL, {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify({
            email,
            returnUrl: window.location.origin + '/login.html#reset'
          })
        });

        document.getElementById('resetEmail').value = email;
        resetCard.classList.remove('d-none');
        showToast('Check your email', 'We sent a 6-digit code.');

      } catch(err){
        console.error('Forgot PIN fetch error', err);
        showToast('Error', 'Could not send reset email.');
      }
    });

    document.getElementById('closeReset').addEventListener('click', () => {
      resetCard.classList.add('d-none');
    });

    // ===== Reset submit (verify code, set new PIN) =====
    document.getElementById('resetForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email  = document.getElementById('resetEmail').value.trim().toLowerCase();
      const code   = document.getElementById('resetCode').value.trim();
      const newPin = document.getElementById('newPin').value.trim();

      try {
        const rec = await fetchUser(email);
        if(!rec){
          showToast('Reset failed', 'Account not found.');
          return;
        }

        const fields = rec.fields || {};

        if(!fields.reset_code || fields.reset_code.toString() !== code){
          showToast('Reset failed', 'Invalid code.');
          return;
        }

        if (fields.reset_expires) {
          const exp = new Date(fields.reset_expires);
          if (exp.getTime() < Date.now()) {
            showToast('Reset failed', 'Code expired.');
            return;
          }
        }

        const pin_hash = await sha256(newPin);

        // IMPORTANT: clear reset fields with null for Airtable
        await patchUser(rec.id, {
          pin_hash,
          reset_code: null,
          reset_expires: null
        });

        setSession(email);
        showToast('PIN updated', 'You are now logged in.');
        setTimeout(() => { window.location.href = 'birthdays.html'; }, 600);

      } catch(err){
        console.error('Reset error:', err);
        showToast('Error', 'Could not update your PIN. Please try again.');
      }
    });

    if (window.location.hash === '#reset') {
      resetCard.classList.remove('d-none');
    }
  </script>
</body>
</html>
