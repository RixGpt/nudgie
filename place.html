<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nudgie – Place Reminders</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="favicon.ico">
  </head>
  <body>
    <!-- Nav -->
    <nav class="navbar navbar-expand-sm bg-white border-bottom">
      <div class="container">
        <a class="navbar-brand fw-bold text-brand" href="index.html">Nudgie</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
          aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div id="nav" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
            <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
            <li class="nav-item">
              <button class="btn btn-outline-secondary ms-sm-2" onclick="logout()">Logout</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Loading overlay -->
    <div id="loadingOverlay"
         class="position-fixed top-0 start-0 vw-100 vh-100 d-none
                d-flex flex-column justify-content-center align-items-center
                bg-dark bg-opacity-50 text-white"
         style="z-index:1055;">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <p class="mt-3 mb-0">Loading your place reminders…</p>
    </div>

    <!-- Main -->
    <main class="py-5">
      <div class="container">
        
        <nav class="mb-3" role="navigation" aria-label="Section menu">
          <ul class="nav nav-pills bg-body-tertiary p-1 rounded-3 border">
            <li class="nav-item"><a class="nav-link" href="dates.html">Birthdays</a></li>
            <li class="nav-item"><a class="nav-link active" href="place.html" aria-current="page">Place</a></li>
            <li class="nav-item"><a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Special Dates</a></li>
          </ul>
        </nav>
        
        <h1 class="fw-semibold mb-3">Place Reminders</h1>
        <p class="text-muted">
          We’ll remind you at the next due date. Hit <strong>Done</strong> when you change an item and we’ll set the next date automatically.
          Need more time? Tap <strong>Delay 1 month</strong>.
        </p>

        <!-- Toggle button + form -->
        <button id="toggleFormBtn" class="btn btn-outline-primary btn-sm mb-3">+ Add a Place Reminder</button>

        <div id="placeFormContainer" class="card card-body mb-4 d-none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Add a Place Reminder</h6>
            <button id="hideFormBtn" class="btn btn-sm btn-outline-secondary">Hide</button>
          </div>

          <form id="placeForm" class="row g-2">
            <div class="col-md-4">
              <label for="itemType" class="form-label">Item</label>
              <select id="itemType" class="form-select" required>
                <option value="">Select Item Type</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="name" class="form-label">Friendly Name</label>
              <input type="text" id="name" class="form-control" placeholder="e.g., Upstairs filter" required>
            </div>
            <div class="col-md-4">
              <label for="lastUpdated" class="form-label">Last Changed</label>
              <input type="date" id="lastUpdated" class="form-control" required>
            </div>
            <div class="col-12 col-md-4">
              <button type="submit" class="btn btn-primary w-100" id="addBtn">
                <span class="spinner-border spinner-border-sm me-2 d-none" id="addSpin" aria-hidden="true"></span>
                Add Reminder
              </button>
            </div>
          </form>
        </div>

        <!-- List card -->
        <div class="card">
          <div class="card-body">
            <div id="placeList" class="vstack gap-2">
              <!-- rows injected here -->
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-top py-3">
      <div class="container text-center text-muted small">
        © <span id="year"></span> Nudgie
      </div>
    </footer>

    <!-- Logic -->
    <script>
      // Footer year
      document.getElementById('year').textContent = new Date().getFullYear();

      // Auth + API config
      const airtableApiKey = "patvZfxpDZOYbjS27.dc2df00ca0e49de14030866cf08b05111606b9c79ad1f3d7a436a7bd697617ab";
      const baseId = "appGMW34rQEzsyHbj";
      const placeTable = "place";
      const itemTypesTable = "itemTypes";
      const email = localStorage.getItem("userEmail");
      if (!email) window.location.href = "login.html";

      const apiURL = `https://api.airtable.com/v0/${baseId}/${placeTable}`;
      const itemTypesURL = `https://api.airtable.com/v0/${baseId}/${itemTypesTable}`;

      function logout(){
        localStorage.removeItem("userEmail");
        window.location.href = "login.html";
      }

      // Overlay helpers
      function showLoading(){ document.getElementById("loadingOverlay").classList.remove("d-none"); }
      function hideLoading(){ document.getElementById("loadingOverlay").classList.add("d-none"); }

      // Date helpers
      function ymd(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${da}`; }
      function pad2(n){ return String(n).padStart(2,'0'); }
      const MONS=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      function prettyYMD(iso){
        if(!iso) return "—";
        const s = iso.includes("T") ? iso.split("T")[0] : iso;
        const m=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) return "—";
        const [,y,mm,dd]=m; return `${dd} ${MONS[parseInt(mm,10)-1]} ${y}`;
      }
      function addMonths(iso, months){
        if(!iso) return "";
        const d=new Date(iso); if(isNaN(d)) return "";
        d.setMonth(d.getMonth()+Number(months||0)); return ymd(d);
      }
      function daysUntil(iso){
        if(!iso) return "—";
        const today = new Date(new Date().toDateString());
        const due = new Date(iso);
        const diff = Math.round((due - today)/(1000*60*60*24));
        if (diff === 0) return "Today ✅";
        if (diff === 1) return "1 day left";
        return `${diff} days left`;
      }

      // Fetch helper
      async function safeFetch(url, options){
        const res = await fetch(url, options);
        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { data = { error:{ message:text } }; }
        if(!res.ok){ throw new Error(data?.error?.message || `${res.status} ${res.statusText}`); }
        return data;
      }

      // Item types
      const itemTypeById = {};
      const itemTypeByName = {};
      async function loadItemTypes(){
        const data = await safeFetch(itemTypesURL, { headers:{ Authorization:`Bearer ${airtableApiKey}` } });
        const dd = document.getElementById("itemType");
        if (dd) dd.innerHTML = '<option value="">Select Item Type</option>';
        (data.records || []).forEach(rec=>{
          const id = rec.id;
          const { itemName, intervalMonths } = rec.fields || {};
          if(!itemName) return;
          itemTypeById[id] = { itemName, intervalMonths };
          itemTypeByName[itemName] = { itemName, intervalMonths };
          if (dd) {
            const opt=document.createElement("option");
            opt.value=id; opt.textContent=itemName; dd.appendChild(opt);
          }
        });
      }

      // Render helpers
      function rowView(rec){
        const f = rec.fields || {};
        const id = rec.id;
        const dueISO = f.nextDue || f.nextDueISO || "";
        const dueStr = prettyYMD(dueISO);
        const lastStr = prettyYMD(f.lastUpdated);
        const leftStr = daysUntil(dueISO);

        return `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-brand fw-semibold">${dueStr}</div>
              <div><strong>${f.name || ""}</strong> ${f.itemTypeName ? "· " + f.itemTypeName : ""}</div>
            </div>
            <div class="text-end">
              <div>♻️ ${lastStr}</div>
              <div class="text-muted">⏰ ${leftStr}</div>
            </div>
          </div>
          <div class="mt-2 d-flex flex-wrap gap-2 justify-content-end">
            <button class="btn btn-sm btn-outline-success" onclick="markDone('${id}')">Done</button>
            <button class="btn btn-sm btn-outline-warning" onclick="delayReminder('${id}')">Delay 1 month</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="enterEdit('${id}')">Edit</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteReminder('${id}')">Delete</button>
          </div>
        `;
      }

      function rowEdit(rec){
        const f = rec.fields || {};
        const id = rec.id;
        const options = Object.values(itemTypeByName).map(it=>{
          const sel = (f.itemTypeName === it.itemName) ? "selected" : "";
          return `<option value="${it.itemName}" ${sel}>${it.itemName}</option>`;
        }).join("");
        return `
          <div class="row g-2 align-items-end">
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Friendly Name</label>
              <input type="text" id="editName-${id}" class="form-control form-control-sm"
                     value="${(f.name || "").replace(/"/g,'&quot;')}">
            </div>
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Item Type</label>
              <select id="editItemType-${id}" class="form-select form-select-sm">${options}</select>
            </div>
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Last Changed</label>
              <input type="date" id="editLastUpdated-${id}" class="form-control form-control-sm" value="${f.lastUpdated || ""}">
            </div>
            <div class="col-12">
              <button class="btn btn-sm btn-success" onclick="saveEdit('${id}')">Save</button>
              <button class="btn btn-sm btn-secondary ms-1" onclick="exitEdit('${id}')">Cancel</button>
            </div>
          </div>
        `;
      }

      function enterEdit(id){
        document.getElementById(`viewRow-${id}`).classList.add("d-none");
        document.getElementById(`editRow-${id}`).classList.remove("d-none");
      }
      function exitEdit(id){
        document.getElementById(`editRow-${id}`).classList.add("d-none");
        document.getElementById(`viewRow-${id}`).classList.remove("d-none");
      }

      async function loadPlaces(){
        const list = document.getElementById("placeList");
        list.innerHTML = "";
        showLoading();

        const filter = `{email} = "${email}"`;
        const data = await safeFetch(`${apiURL}?filterByFormula=${encodeURIComponent(filter)}`, {
          headers:{ Authorization:`Bearer ${airtableApiKey}` }
        });

        const records = data.records || [];
        list.innerHTML = "";

        if (records.length === 0){
          list.innerHTML = `
            <div class="text-muted text-center py-4">
              No place reminders yet.<br/>
              <button class="btn btn-sm btn-primary mt-3" id="emptyAdd">Add your first</button>
            </div>`;
          document.getElementById('emptyAdd').addEventListener('click', ()=>{
            document.getElementById("placeFormContainer").classList.remove("d-none");
            document.getElementById("toggleFormBtn").classList.add("d-none");
          });
          hideLoading(); return;
        }

        // Sort by soonest next due
        records.sort((a,b)=>{
          const aISO = a.fields?.nextDue || a.fields?.nextDueISO;
          const bISO = b.fields?.nextDue || b.fields?.nextDueISO;
          const ad = aISO ? new Date(aISO) : new Date('9999-12-31');
          const bd = bISO ? new Date(bISO) : new Date('9999-12-31');
          return ad - bd;
        });

        records.forEach(r=>{
          const wrap = document.createElement("div");
          wrap.className = "border rounded p-3";
          wrap.innerHTML = `
            <div id="viewRow-${r.id}">
              ${rowView(r)}
            </div>
            <div id="editRow-${r.id}" class="d-none">
              ${rowEdit(r)}
            </div>
          `;
          list.appendChild(wrap);
        });

        hideLoading();
      }

      // Actions with overlay
      async function saveEdit(id){
        showLoading();
        try {
          const name = document.getElementById(`editName-${id}`).value.trim();
          const itemTypeName = document.getElementById(`editItemType-${id}`).value;
          const lastUpdated  = document.getElementById(`editLastUpdated-${id}`).value;

          const it = itemTypeByName[itemTypeName];
          if (!it) { alert("Please select a valid item type."); return; }

          const nextDue = addMonths(lastUpdated, it.intervalMonths);

          await safeFetch(`${apiURL}/${id}`, {
            method:"PATCH",
            headers:{ Authorization:`Bearer ${airtableApiKey}`,"Content-Type":"application/json" },
            body: JSON.stringify({ fields:{ name, itemTypeName, intervalMonths: it.intervalMonths, lastUpdated, nextDue } })
          });
          await loadPlaces();
        } finally { hideLoading(); }
      }

      async function deleteReminder(id){
        if(!confirm("Delete this reminder?")) return;
        showLoading();
        try {
          await safeFetch(`${apiURL}/${id}`, {
            method:"DELETE",
            headers:{ Authorization:`Bearer ${airtableApiKey}` }
          });
          await loadPlaces();
        } finally { hideLoading(); }
      }

      async function markDone(id){
        showLoading();
        try {
          const rec = await safeFetch(`${apiURL}/${id}`, { headers:{ Authorization:`Bearer ${airtableApiKey}` } });
          const interval = rec.fields?.intervalMonths || itemTypeByName[rec.fields?.itemTypeName]?.intervalMonths || 6;
          const todayISO = ymd(new Date());
          const nextDue  = addMonths(todayISO, interval);

          await safeFetch(`${apiURL}/${id}`, {
            method:"PATCH",
            headers:{ Authorization:`Bearer ${airtableApiKey}`,"Content-Type":"application/json" },
            body: JSON.stringify({ fields:{ lastUpdated: todayISO, nextDue } })
          });
          await loadPlaces();
        } finally { hideLoading(); }
      }

      async function delayReminder(id){
        showLoading();
        try {
          const rec     = await safeFetch(`${apiURL}/${id}`, { headers:{ Authorization:`Bearer ${airtableApiKey}` } });
          const baseISO = rec.fields?.nextDue || rec.fields?.nextDueISO || ymd(new Date());
          const delayed = addMonths(baseISO, 1);

          await safeFetch(`${apiURL}/${id}`, {
            method:"PATCH",
            headers:{ Authorization:`Bearer ${airtableApiKey}`,"Content-Type":"application/json" },
            body: JSON.stringify({ fields:{ nextDue: delayed } })
          });
          await loadPlaces();
        } finally { hideLoading(); }
      }

      // Create handler with button spinner + overlay
      document.getElementById("placeForm")?.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const addBtn  = document.getElementById("addBtn");
        const addSpin = document.getElementById("addSpin");

        const itemTypeId  = document.getElementById("itemType").value;
        const name        = document.getElementById("name").value.trim();
        const lastUpdated = document.getElementById("lastUpdated").value;

        const it = itemTypeById[itemTypeId];
        if (!it) { alert("Select a valid item type."); return; }

        const nextDue = addMonths(lastUpdated, it.intervalMonths);

        addBtn.disabled = true; addSpin.classList.remove("d-none");
        showLoading();

        try {
          await safeFetch(apiURL, {
            method:"POST",
            headers:{ Authorization:`Bearer ${airtableApiKey}`,"Content-Type":"application/json" },
            body: JSON.stringify({
              fields:{ email, name, itemTypeName: it.itemName, intervalMonths: it.intervalMonths, lastUpdated, nextDue }
            })
          });

          e.target.reset();
          document.getElementById("hideFormBtn").click();
          await loadPlaces();
        } finally {
          hideLoading();
          addBtn.disabled = false; addSpin.classList.add("d-none");
        }
      });

      // Form toggles
      document.getElementById("toggleFormBtn").addEventListener("click", ()=>{
        document.getElementById("placeFormContainer").classList.remove("d-none");
        document.getElementById("toggleFormBtn").classList.add("d-none");
      });
      document.getElementById("hideFormBtn").addEventListener("click", ()=>{
        document.getElementById("placeFormContainer").classList.add("d-none");
        document.getElementById("toggleFormBtn").classList.remove("d-none");
      });

      // Init
      (async function init(){
        showLoading();
        try {
          await loadItemTypes();
          await loadPlaces();
        } finally {
          hideLoading();
        }
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
