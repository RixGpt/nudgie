<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nudgie â€” Birthdays</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .nudgie-container { max-width:820px; }
    .brand { font-weight:700; letter-spacing:0.2px; }
    .pointer { cursor: pointer; }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container nudgie-container py-2 d-flex justify-content-between align-items-center">
      <a class="navbar-brand brand" href="index.html">Nudgie</a>
      <div class="d-flex gap-3">
        <a class="nav-link" href="about.html">About</a>
        <a class="nav-link" href="contact.html">Contact</a>
        <button class="btn btn-outline-secondary btn-sm" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container nudgie-container py-4">
    <div class="row g-3">
      <div class="col-12 d-flex justify-content-between align-items-end">
        <div>
          <h1 class="h4 mb-1">Birthdays</h1>
          <p class="text-muted mb-0">Add, edit, and see upcoming birthdays.</p>
        </div>
        <a class="btn btn-primary" href="login.html" id="loginCta" style="display:none;">Log in</a>
      </div>

      <!-- Add form -->
      <div class="col-12" id="addWrap" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-body">
            <form id="addForm" class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">First name</label>
                <input id="firstName" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">Last name</label>
                <input id="lastName" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Date of birth</label>
                <input id="dob" type="date" class="form-control" required>
              </div>
              <div class="col-md-1">
                <button class="btn btn-primary w-100" type="submit">Add</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- List -->
      <div class="col-12" id="listWrap" style="display:none;">
        <div class="card shadow-sm">
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th style="width:140px;">Date</th>
                  <th style="width:140px;">Next birthday</th>
                  <th style="width:80px;">Age</th>
                  <th style="width:130px;" class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div class="col-12" id="emptyState" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-body text-center text-muted">
            <div class="mb-2">No birthdays yet.</div>
            <div>Add one above to get started. ðŸŽ‚</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit birthday</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm" class="row g-2">
            <input type="hidden" id="editId">
            <div class="col-md-6">
              <label class="form-label small text-muted mb-1">First name</label>
              <input id="editFirst" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted mb-1">Last name</label>
              <input id="editLast" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted mb-1">Date of birth</label>
              <input id="editDob" type="date" class="form-control" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEdit">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== CONFIG =====
    const AIRTABLE_TOKEN = 'pat7FJIZ2jVBPvyFJ.f3f48877944f4a6e2ac0d591468113c051dce38e080d11a4821c37151c5d6a9b'; // replace
    const AIRTABLE_BASE = 'appDw2ve8ICnaUL6g'; // replace
    const BDAY_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE}/birthdays`;

    const headers = { Authorization: `Bearer ${AIRTABLE_TOKEN}`, 'Content-Type':'application/json' };

    // ===== Session helpers =====
    function session(){ try{ return JSON.parse(localStorage.getItem('nudgie_session')||'null'); }catch(_){ return null } }
    function ensureLogin(){
      const s = session();
      const addWrap = document.getElementById('addWrap');
      const listWrap = document.getElementById('listWrap');
      const loginCta = document.getElementById('loginCta');
      if(!s){ loginCta.style.display='inline-block'; return null; }
      addWrap.style.display='';
      listWrap.style.display='';
      return s;
    }

    document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('nudgie_session'); location.href = 'login.html'; });

    // ===== Date helpers =====
    function nextBirthdayFromDob(dobIso){
      // Compute next birthday (local time) from a YYYY-MM-DD (or ISO) date
      const d0 = new Date(dobIso);
      const now = new Date();
      const y = now.getFullYear();
      let nb = new Date(y, d0.getMonth(), d0.getDate());
      if (nb < new Date(now.getFullYear(), now.getMonth(), now.getDate())) nb = new Date(y+1, d0.getMonth(), d0.getDate());
      return nb.toISOString();
    }
    function ageTurning(dobIso, nextIso){
      const d0 = new Date(dobIso);
      const nx = new Date(nextIso);
      return nx.getFullYear() - d0.getFullYear();
    }
    function fmtDate(iso){ const d=new Date(iso); return d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}); }

    // ===== Airtable helpers =====
    async function fetchMine(email){
      const url = BDAY_URL + `?filterByFormula=${encodeURIComponent(`LOWER({user_email})='${email.toLowerCase()}'`)}&pageSize=100`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` } });
      const data = await res.json();
      return data.records||[];
    }
    async function createRec(fields){
      const res = await fetch(BDAY_URL, { method:'POST', headers, body: JSON.stringify({ fields }) });
      return res.json();
    }
    async function patchRec(id, fields){
      const res = await fetch(`${BDAY_URL}/${id}`, { method:'PATCH', headers, body: JSON.stringify({ fields }) });
      return res.json();
    }
    async function deleteRec(id){ await fetch(`${BDAY_URL}/${id}`, { method:'DELETE', headers:{ Authorization: `Bearer ${AIRTABLE_TOKEN}` }}); }

    // ===== Render =====
    const tbody = document.getElementById('tbody');
    function renderRows(rows){
      tbody.innerHTML = '';
      rows.forEach(rec => {
        const f = rec.fields || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${(f.first_name||'') + ' ' + (f.last_name||'')}</td>
          <td>${f.date ? fmtDate(f.date) : ''}</td>
          <td>${f.next_birthday ? fmtDate(f.next_birthday) : ''}</td>
          <td>${(f.date && f.next_birthday) ? ageTurning(f.date, f.next_birthday) : ''}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-secondary me-1" data-action="edit">Edit</button>
            <button class="btn btn-sm btn-outline-danger" data-action="del">Delete</button>
          </td>`;

        tr.querySelector('[data-action="edit"]').addEventListener('click', ()=> openEdit(rec));
        tr.querySelector('[data-action="del"]').addEventListener('click', async ()=>{
          if(confirm('Delete this birthday?')){ await deleteRec(rec.id); await load(); }
        });

        tbody.appendChild(tr);
      });
    }

    // ===== Edit modal logic =====
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    function openEdit(rec){
      const f = rec.fields||{};
      document.getElementById('editId').value = rec.id;
      document.getElementById('editFirst').value = f.first_name||'';
      document.getElementById('editLast').value = f.last_name||'';
      document.getElementById('editDob').value = (f.date||'').substring(0,10);
      editModal.show();
    }
    document.getElementById('saveEdit').addEventListener('click', async ()=>{
      const id = document.getElementById('editId').value;
      const first = document.getElementById('editFirst').value.trim();
      const last  = document.getElementById('editLast').value.trim();
      const dob   = document.getElementById('editDob').value;
      const next  = nextBirthdayFromDob(dob);
      await patchRec(id, { first_name:first, last_name:last, date:dob, next_birthday: next });
      editModal.hide();
      await load();
    });

    // ===== Add flow =====
    document.getElementById('addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const s = session(); if(!s) return;
      const first = document.getElementById('firstName').value.trim();
      const last  = document.getElementById('lastName').value.trim();
      const dob   = document.getElementById('dob').value;
      const next  = nextBirthdayFromDob(dob);
      await createRec({ user_email: s.email, first_name:first, last_name:last, date:dob, next_birthday: next });
      (e.target).reset();
      await load();
    });

    // ===== Load & init =====
    async function load(){
      const s = session();
      const empty = document.getElementById('emptyState');
      if(!s) return;
      let rows = await fetchMine(s.email);
      // if next_birthday missing, compute client-side and patch once
      const fixes = [];
      for(const r of rows){
        const f=r.fields||{};
        if(f.date && !f.next_birthday){
          const nb = nextBirthdayFromDob(f.date);
          fixes.push(patchRec(r.id, { next_birthday: nb }));
          f.next_birthday = nb;
        }
      }
      if(fixes.length) await Promise.all(fixes);

      // sort by next
      rows = rows.sort((a,b)=> new Date(a.fields.next_birthday||'2100-01-01') - new Date(b.fields.next_birthday||'2100-01-01'));

      if(rows.length===0){ empty.style.display=''; document.getElementById('listWrap').style.display='none'; }
      else { empty.style.display='none'; document.getElementById('listWrap').style.display=''; renderRows(rows); }
    }

    (async function init(){
      const s = ensureLogin();
      if(!s) return;
      await load();
    })();
  </script>
</body>
</html>
