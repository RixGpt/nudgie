<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nudgie - Place Reminders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <!-- Font override -->
  <style> body { font-family: Tahoma, Arial, sans-serif; } </style>
</head>
<body>

  <!-- Header -->
  <div class="header-bar mb-4">
    <div class="container-narrow px-3 px-sm-4 d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <i class="fas fa-dove"></i>
        <div>
          <h1 class="title mb-0">Nudgie</h1>
          <p class="subtitle mb-0">A smart nudge when you need it</p>
        </div>
      </div>
      <a href="index.html" class="btn btn-outline-primary btn-sm">Home</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container-narrow px-3 px-sm-4">

    <div id="menu-container"></div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">Place Reminders</h2>
    </div>

    <!-- Toggle Button -->
    <button id="toggleFormBtn" class="btn btn-outline-primary btn-sm mb-3">
      <i class="fas fa-plus"></i> Add a Place Reminder
    </button>

    <!-- Hidden Form Container -->
    <div id="placeFormContainer" class="card card-body shadow-sm mb-4 d-none" style="background-color: #fff;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Add a Place Reminder</h6>
        <button id="hideFormBtn" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-minus"></i> Hide
        </button>
      </div>
      <form id="placeForm" class="row gx-2 gy-2">
        <div class="col-md-4">
          <label for="itemType" class="form-label">Item</label>
          <select id="itemType" class="form-select" required>
            <option value="">Select Item Type</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="name" class="form-label">Friendly Name</label>
          <input type="text" id="name" class="form-control" placeholder="e.g., Upstairs filter" required />
        </div>
        <div class="col-md-4">
          <label for="lastUpdated" class="form-label">Last Changed</label>
          <input type="date" id="lastUpdated" class="form-control" required />
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Add Reminder</button>
        </div>
      </form>
    </div>

    <div class="alert alert-warning mb-4 d-flex align-items-center" role="alert">
      <span>
        We'll remind you at the next due date. <br/>
        Hit <strong>Done</strong> when you change an item — we’ll set the next due date automatically. <br/>
        <strong>Need a little more time?</strong> Hit the clock to delay the next reminder by 1 month.
      </span>
      <i class="fas fa-house ms-2 text-warning"></i>
    </div>

    <!-- List -->
    <div id="placeList" class="reminder-list"></div>
  </div>

  <!-- Places Logic -->
  <script>
    const airtableApiKey = "patvZfxpDZOYbjS27.dc2df00ca0e49de14030866cf08b05111606b9c79ad1f3d7a436a7bd697617ab";
    const baseId = "appGMW34rQEzsyHbj";
    const placeTable = "place";
    const itemTypesTable = "itemTypes";
    const email = localStorage.getItem("userEmail");
    if (!email) window.location.href = "login.html";

    const apiURL = `https://api.airtable.com/v0/${baseId}/${placeTable}`;
    const itemTypesURL = `https://api.airtable.com/v0/${baseId}/${itemTypesTable}`;

    // itemTypes are stored as records with itemName + intervalMonths
    // We'll map by recordId for the create flow; and by name for edit flow.
    const itemTypeById = {};    // id -> { itemName, intervalMonths }
    const itemTypeByName = {};  // itemName -> { itemName, intervalMonths }

    // ---------- Helpers ----------
    const listContainer = () => document.getElementById("placeList");

    // Fallback formatter for YYYY-MM-DD -> DD MMM YYYY (string-based, timezone-proof)
    function prettyYMD(iso) {
      if (!iso) return "—";
      const s = (iso.includes("T") ? iso.split("T")[0] : iso).trim();
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return "—";
      const [, y, mm, dd] = m;
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      return `${dd} ${months[parseInt(mm,10)-1]} ${y}`;
    }

    function ymd(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function addMonths(isoDateStr, months) {
      if (!isoDateStr) return "";
      const d = new Date(isoDateStr);
      if (isNaN(d)) return "";
      d.setMonth(d.getMonth() + Number(months || 0));
      return ymd(d);
    }

    async function safeFetch(url, options) {
      const res = await fetch(url, options);
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { error: { message: text } }; }
      if (!res.ok) {
        const msg = data?.error?.message || `${res.status} ${res.statusText}`;
        throw new Error(msg);
      }
      return data;
    }

    // ---------- Load item types for the form ----------
    async function loadItemTypes() {
      const data = await safeFetch(itemTypesURL, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      const dropdown = document.getElementById("itemType");
      if (dropdown) dropdown.innerHTML = '<option value="">Select Item Type</option>';

      (data.records || []).forEach(rec => {
        const id = rec.id;
        const { itemName, intervalMonths } = rec.fields || {};
        if (!itemName) return;
        itemTypeById[id] = { itemName, intervalMonths };
        itemTypeByName[itemName] = { itemName, intervalMonths };
        if (dropdown) {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = itemName;
          dropdown.appendChild(opt);
        }
      });
    }

    // ---------- CRUD ----------
    async function loadPlaces() {
      const el = listContainer();
      if (!el) return;
      el.innerHTML = `<div class="text-muted text-center py-3">Loading...</div>`;

      const filterFormula = `{email} = "${email}"`;
      const data = await safeFetch(`${apiURL}?filterByFormula=${encodeURIComponent(filterFormula)}`, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });

      el.innerHTML = "";
      const records = (data.records || []);

      if (records.length === 0) {
        el.innerHTML = `<div class="text-muted text-center py-3">No reminders found.</div>`;
        return;
      }

      // Sort by nextDueISO (display like birthdays page)
      records.sort((a, b) => {
        const aISO = a.fields?.nextDueISO || a.fields?.nextDue || null;
        const bISO = b.fields?.nextDueISO || b.fields?.nextDue || null;
        const aDate = aISO ? new Date(aISO) : new Date("9999-12-31");
        const bDate = bISO ? new Date(bISO) : new Date("9999-12-31");
        return aDate - bDate;
      });

      records.forEach(rec => {
        const id = rec.id;
        const {
          name,
          itemTypeName,
          lastUpdated,            // raw YYYY-MM-DD
          nextDue,                // raw YYYY-MM-DD
          lastUpdatedDisplay,     // optional formula in Airtable
          nextDueDisplay          // optional formula in Airtable
        } = rec.fields || {};

        // Display strings (prefer Airtable display fields)
        const dueStr = nextDueDisplay || prettyYMD(nextDue);
        const lastStr = lastUpdatedDisplay || prettyYMD(lastUpdated);

        // Build options for edit select (by name)
        const options = Object.values(itemTypeByName).map(val => {
          const selected = (itemTypeName === val.itemName) ? "selected" : "";
          return `<option value="${val.itemName}" ${selected}>${val.itemName}</option>`;
        }).join("");

        const row = document.createElement("div");
        row.className = "reminder-item";
        row.id = `card-${id}`;
        row.innerHTML = `
          <div class="card-view">
            <div class="row-top">
              <div class="birthday-date">${dueStr}</div>
              <div class="row-tools">
                <div class="next-reminder"><i class="fa-regular fa-clock me-1"></i>${lastStr}</div>
                <div class="dropdown">
                  <button class="kebab-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Actions">
                    <i class="fa-solid fa-ellipsis-vertical kebab-icon"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><button class="dropdown-item" onclick="markDone('${id}')"><i class="fa-solid fa-check me-2"></i>Done</button></li>
                    <li><button class="dropdown-item" onclick="delayReminder('${id}')"><i class="fa-solid fa-clock me-2"></i>Delay 1 month</button></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item" onclick="enterEdit(document.getElementById('card-${id}'))"><i class="fa-solid fa-pen me-2"></i>Edit</button></li>
                    <li><button class="dropdown-item text-danger" onclick="deleteReminder('${id}')"><i class="fa-solid fa-trash me-2"></i>Delete</button></li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="reminder-title">
              ${name || ""} <span class="last-name">${itemTypeName || ""}</span>
            </div>
          </div>

          <div class="card-edit">
            <div class="edit-grid">
              <div>
                <label class="form-label">Friendly Name</label>
                <input type="text" id="editName-${id}" class="form-control form-control-sm"
                       value="${(name || "").replace(/"/g,'&quot;')}" />
              </div>
              <div>
                <label class="form-label">Item Type</label>
                <select id="editItemType-${id}" class="form-select form-select-sm">${options}</select>
              </div>
              <div>
                <label class="form-label">Last Changed</label>
                <input type="date" id="editLastUpdated-${id}" class="form-control form-control-sm" value="${lastUpdated || ""}" />
              </div>
            </div>
            <div class="edit-actions">
              <button class="btn btn-sm btn-success" onclick="saveEdit('${id}')">Save</button>
              <button class="btn btn-sm btn-secondary" onclick="exitEdit(document.getElementById('card-${id}'))">Cancel</button>
            </div>
          </div>
        `;
        el.appendChild(row);
      });
    }

    async function saveEdit(id) {
      const name = document.getElementById(`editName-${id}`).value.trim();
      const itemTypeName = document.getElementById(`editItemType-${id}`).value;
      const lastUpdated = document.getElementById(`editLastUpdated-${id}`).value;

      const it = itemTypeByName[itemTypeName];
      if (!it) { alert("Please select a valid item type."); return; }

      const nextDue = addMonths(lastUpdated, it.intervalMonths);

      await safeFetch(`${apiURL}/${id}`, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fields: {
            name,
            itemTypeName,
            intervalMonths: it.intervalMonths,
            lastUpdated,
            nextDue
          }
        })
      });
      loadPlaces();
    }

    async function deleteReminder(id) {
      if (!confirm("Delete this reminder?")) return;
      await safeFetch(`${apiURL}/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      loadPlaces();
    }

    async function markDone(id) {
      // set lastUpdated = today, advance by intervalMonths
      const rec = await safeFetch(`${apiURL}/${id}`, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      const interval = rec.fields?.intervalMonths || itemTypeByName[rec.fields?.itemTypeName]?.intervalMonths || 6;
      const today = new Date();
      const todayISO = ymd(today);
      const nextDue = addMonths(todayISO, interval);

      await safeFetch(`${apiURL}/${id}`, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ fields: { lastUpdated: todayISO, nextDue } })
      });
      loadPlaces();
    }

    async function delayReminder(id) {
      const rec = await safeFetch(`${apiURL}/${id}`, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      const base = rec.fields?.nextDue ? new Date(rec.fields.nextDue) : new Date();
      base.setMonth(base.getMonth() + 1);
      const delayed = ymd(base);

      await safeFetch(`${apiURL}/${id}`, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ fields: { nextDue: delayed } })
      });
      loadPlaces();
    }

    // Create handler
    document.getElementById("placeForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const itemTypeId = document.getElementById("itemType").value;
      const name = document.getElementById("name").value.trim();
      const lastUpdated = document.getElementById("lastUpdated").value;

      const it = itemTypeById[itemTypeId];
      if (!it) { alert("Select a valid item type."); return; }

      const nextDue = addMonths(lastUpdated, it.intervalMonths);

      await safeFetch(apiURL, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fields: {
            email,
            name,
            itemTypeName: it.itemName,
            intervalMonths: it.intervalMonths,
            lastUpdated,
            nextDue
          }
        })
      });

      document.getElementById("placeForm").reset();
      loadPlaces();
    });

    // init
    loadItemTypes().finally(loadPlaces);
  </script>

  <!-- Shared menu -->
  <script>
    fetch('menu.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('menu-container').innerHTML = html;
      });
  </script>

  <!-- Toggle form -->
  <script>
    document.getElementById("toggleFormBtn").addEventListener("click", function () {
      document.getElementById("placeFormContainer").classList.remove("d-none");
      this.classList.add("d-none");
    });
    document.getElementById("hideFormBtn").addEventListener("click", function () {
      document.getElementById("placeFormContainer").classList.add("d-none");
      document.getElementById("toggleFormBtn").classList.remove("d-none");
    });
  </script>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
