<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nudgie â€” Login</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a;
      --muted:#475569;  /* match About */
      --border: rgba(15, 23, 42, 0.10);
      --soft:#f6f8fb;
    }

    body { color: var(--ink); background: #fff; }
    a { text-decoration: none; }
    a:hover { text-decoration: underline; }

    .brand { font-weight: 800; letter-spacing: 0.2px; }

    .wrap { max-width: 720px; } /* match About */

    .page-title{
      font-weight: 800;
      letter-spacing: -0.01em;
    }

    .lead-muted{
      color: var(--muted);
      font-size: 1.05rem;
    }

    .divider{
      height: 1px;
      background: var(--border);
      margin: 1.75rem 0;
    }

    .section-title{
      font-size: 1.15rem;
      font-weight: 800;
      letter-spacing: -0.01em;
    }
  </style>
</head>

<body>
  <!-- Nav (matches About.html exactly) -->
  <div id="site-header"></div>

  <!-- Content -->
  <main class="container py-5">
    <div class="mx-auto wrap">
      <h1 class="page-title display-6 mb-3">Login</h1>
      <p class="lead-muted mb-4">
        Use your email and a 4â€“6 digit PIN. First time? Weâ€™ll create your account.
      </p>

      <div class="divider"></div>

      <div class="row g-4">

        <!-- Login Card -->
        <div class="col-12">
          <div class="card shadow-sm border border-secondary-subtle">
            <div class="card-body">
              <h2 class="section-title mb-2">Log in / Sign up</h2>
              <p class="text-muted small mb-3">We keep it simple: email + PIN. No passwords to forget.</p>

              <form id="loginForm" class="row g-2 align-items-end">
                <div class="col-md-7">
                  <label for="email" class="form-label small text-muted mb-1">Email</label>
                  <input id="email" type="email" class="form-control" placeholder="you@example.com" required>
                </div>

                <div class="col-md-5">
                  <label for="pin" class="form-label small text-muted mb-1">PIN</label>
                  <input
                    id="pin"
                    type="password"
                    inputmode="numeric"
                    pattern="[0-9]{4,6}"
                    minlength="4"
                    maxlength="6"
                    class="form-control"
                    placeholder="â€¢â€¢â€¢â€¢"
                    required
                  >
                </div>

                <div class="col-12 d-flex align-items-center gap-2 mt-2">
                  <button class="btn btn-primary" type="submit">Continue</button>
                  <button id="forgotBtn" class="btn btn-link" type="button">Forgot PIN?</button>
                </div>

                <div class="col-12 small text-muted mt-2">By continuing you agree to be gently nudged. ðŸ’œ</div>
              </form>
            </div>
          </div>
        </div>

        <!-- Reset Card (Firebase password reset email) -->
        <div class="col-12 d-none" id="resetCard">
          <div class="card bg-light border border-secondary-subtle shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="section-title mb-0">Reset your PIN</h2>
                <button class="btn btn-sm btn-outline-secondary" id="closeReset" type="button">Close</button>
              </div>

              <hr class="mt-2 mb-3 border-secondary-subtle">

              <p class="small text-muted mb-3">
                Weâ€™ll email you a reset link. You can set a new 4â€“6 digit PIN from there.
              </p>

              <form id="resetForm" class="row g-2 align-items-end">
                <div class="col-md-8">
                  <label class="form-label small text-muted mb-1">Email</label>
                  <input id="resetEmail" type="email" class="form-control" placeholder="you@example.com" required>
                </div>

                <div class="col-md-4">
                  <button class="btn btn-primary w-100" type="submit">Send reset email</button>
                </div>
              </form>
            </div>
          </div>
        </div>

      </div>

      <div class="divider"></div>

      <p class="small text-muted mb-0">
        Made with ðŸ’œ in Sonoma, California.
      </p>
    </div>
  </main>

  <!-- Footer (match About style) -->
  <div id="site-footer"></div>

  <!-- Toasts -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">Nudgie</strong>
        <small class="text-muted">now</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody">Hello</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="includes.js"></script>

  <!-- Firebase Auth wiring (PIN == password) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    // ===== Firebase config (OK to be public) =====
    const firebaseConfig = {
      apiKey: "AIzaSyAQOmGdg4pwu8I0G9KDFEBTlnQyc3ZFyT0",
      authDomain: "nudgie-def7c.firebaseapp.com",
      projectId: "nudgie-def7c",
      storageBucket: "nudgie-def7c.firebasestorage.app",
      messagingSenderId: "617809838072",
      appId: "1:617809838072:web:10d3553227364219d0200d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ===== Utils =====
    function showToast(title, body){
      document.getElementById('toastTitle').textContent = title || 'Nudgie';
      document.getElementById('toastBody').textContent = body || '';
      const t = new bootstrap.Toast(document.getElementById('toast'));
      t.show();
    }

    // If already logged in, bounce to birthdays
    onAuthStateChanged(auth, (user) => {
      if (user) window.location.href = 'birthdays.html';
    });

    // ===== Login / Signup (PIN = password) =====
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const pin   = document.getElementById('pin').value.trim();

      // simple guard (HTML already enforces, but keep it)
      if (!/^\d{4,6}$/.test(pin)) {
        showToast('PIN not valid', 'Use a 4â€“6 digit PIN.');
        return;
      }

      try {
        // Try login first
        await signInWithEmailAndPassword(auth, email, pin);
        showToast('Welcome', 'You are now logged in.');
        setTimeout(() => { window.location.href = 'birthdays.html'; }, 400);

      } catch (err) {
        // If user doesn't exist yet, create account (your previous behavior)
        if (err?.code === 'auth/user-not-found' || err?.code === 'auth/invalid-credential') {
          try {
            await createUserWithEmailAndPassword(auth, email, pin);
            showToast('Welcome', 'Account created. You are now logged in.');
            setTimeout(() => { window.location.href = 'birthdays.html'; }, 400);
            return;
          } catch (err2) {
            if (err2?.code === 'auth/email-already-in-use') {
              showToast('Login failed', 'Wrong PIN for this email.');
            } else if (err2?.code === 'auth/weak-password') {
              showToast('PIN too short', 'Use 6 digits if Firebase complains.');
            } else {
              console.error('Signup error:', err2);
              showToast('Error', 'Please try again.');
            }
            return;
          }
        }

        console.error('Login error:', err);
        if (err?.code === 'auth/too-many-requests') {
          showToast('Slow down', 'Too many attempts. Try again in a bit.');
        } else {
          showToast('Error', 'Please try again.');
        }
      }
    });

    // ===== Forgot PIN (Firebase reset email) =====
    const resetCard = document.getElementById('resetCard');

    document.getElementById('forgotBtn').addEventListener('click', () => {
      const email = document.getElementById('email').value.trim();
      if (!email) {
        showToast('Forgot PIN', 'Enter your email first.');
        return;
      }
      document.getElementById('resetEmail').value = email;
      resetCard.classList.remove('d-none');
    });

    document.getElementById('closeReset').addEventListener('click', () => {
      resetCard.classList.add('d-none');
    });

    document.getElementById('resetForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('resetEmail').value.trim().toLowerCase();

      try {
        await sendPasswordResetEmail(auth, email);
        showToast('Check your email', 'We sent you a reset link.');
        resetCard.classList.add('d-none');
      } catch (err) {
        console.error('Reset email error:', err);
        // For privacy, don't confirm whether the account exists
        showToast('Check your email', 'If an account exists, youâ€™ll get a reset link.');
      }
    });

    if (window.location.hash === '#reset') {
      resetCard.classList.remove('d-none');
    }
  </script>
</body>
</html>
